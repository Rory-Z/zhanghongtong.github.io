<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="简体中文">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta property="og:type" content="website">
<meta property="og:title" content="张奇怪的blog">
<meta property="og:url" content="https://zhanghongtong.github.io/page/3/index.html">
<meta property="og:site_name" content="张奇怪的blog">
<meta property="og:locale" content="简体中文">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="张奇怪的blog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://zhanghongtong.github.io/page/3/"/>





  <title>张奇怪的blog</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="简体中文">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">张奇怪的blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhanghongtong.github.io/2018/07/25/创建一个足够小的golang应用的Dockerfile/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张奇怪">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张奇怪的blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/25/创建一个足够小的golang应用的Dockerfile/" itemprop="url">创建一个足够小的golang应用的Dockerfile</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-07-25T17:27:04+08:00">
                2018-07-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/docker/" itemprop="url" rel="index">
                    <span itemprop="name">docker</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>之前创建go的docker image时使用的base image是 golang:latest，编译完的image有800+M，太大了，可以在宿主机上先将go编译成可执行文件，然后使用scratch做base image将可执行文件编译成docker image</p>
<h1 id="关于scratch"><a href="#关于scratch" class="headerlink" title="关于scratch"></a>关于scratch</h1><p><a href="https://hub.docker.com/_/scratch/" target="_blank" rel="noopener">scratch</a> 是一非常特别的镜像，这个镜像很有意思的是他是一个空镜像。<br>也就是说大小几乎是 0 。<br>但是不能单独跑起来，只能做基础镜像，然后把main 程序放上去。<br>说白就是是一个线程了，这样有个非常好的优势，镜像小，没有依赖。</p>
<h1 id="开始实验"><a href="#开始实验" class="headerlink" title="开始实验"></a>开始实验</h1><h3 id="创建go程序"><a href="#创建go程序" class="headerlink" title="创建go程序"></a>创建go程序</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import &quot;fmt&quot;</span><br><span class="line"></span><br><span class="line">func main()  &#123;</span><br><span class="line">	fmt.Println(&quot;hello small docker image&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用<code>GOOS=linux GOARCH=amd64 go build .</code>编译成可执行文件</p>
<h3 id="编写Dockerfile"><a href="#编写Dockerfile" class="headerlink" title="编写Dockerfile"></a>编写Dockerfile</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#使用scratch做base images</span><br><span class="line">FROM scratch</span><br><span class="line"></span><br><span class="line">#添加可执行文件</span><br><span class="line">ADD main /</span><br><span class="line"></span><br><span class="line">#运行可执行文件</span><br><span class="line">CMD [ &quot;./main&quot; ]</span><br></pre></td></tr></table></figure>
<p>使用<code>docker build -t test .</code> 命令将Dockerfile编译成docker image</p>
<h3 id="查看docker-image"><a href="#查看docker-image" class="headerlink" title="查看docker image"></a>查看docker image</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># docker images</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">test                latest              3359eedebdad        4 minutes ago       2.03MB</span><br></pre></td></tr></table></figure>
<p>可以看到docker image只有2M多</p>
<h3 id="运行容器"><a href="#运行容器" class="headerlink" title="运行容器"></a>运行容器</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># docker run test</span><br><span class="line">hello small docker image</span><br></pre></td></tr></table></figure>
<h3 id="Done"><a href="#Done" class="headerlink" title="Done"></a>Done</h3>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhanghongtong.github.io/2018/07/17/linux-shell-脚本读取-ini-配置文件/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张奇怪">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张奇怪的blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/17/linux-shell-脚本读取-ini-配置文件/" itemprop="url">linux shell 脚本读取 ini 配置文件</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-07-17T15:06:34+08:00">
                2018-07-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/服务器/" itemprop="url" rel="index">
                    <span itemprop="name">服务器</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>linux shell 脚本读取 ini 配置档打码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">configFile=&quot;./config.ini&quot;</span><br><span class="line">function ReadINIfile()  </span><br><span class="line">&#123;   </span><br><span class="line">	Key=$1</span><br><span class="line">	Section=$2</span><br><span class="line">  	Configfile=$3</span><br><span class="line">	ReadINI=`awk -F &apos;=&apos; &apos;/\[&apos;$Section&apos;\]/&#123;a=1&#125;a==1&amp;&amp;$1~/&apos;$Key&apos;/&#123;print $2;exit&#125;&apos; $Configfile`  </span><br><span class="line"> 	echo &quot;$ReadINI&quot;  </span><br><span class="line">&#125; </span><br><span class="line">itemCount=`ReadINIfile &quot;ItemCount&quot; &quot;General&quot; &quot;$configFile&quot;`</span><br><span class="line">echo $itemCount</span><br><span class="line"></span><br><span class="line">for((i=0; i&lt;itemCount; i++))</span><br><span class="line">do</span><br><span class="line">	Section=&quot;Item&quot;&quot;$i&quot;</span><br><span class="line">	echo $Section</span><br><span class="line">	numTest=`ReadINIfile &quot;NumTest&quot; &quot;$Section&quot; &quot;$configFile&quot;`</span><br><span class="line">	stringTest=`ReadINIfile &quot;StringTest&quot; &quot;$Section&quot; &quot;$configFile&quot;`</span><br><span class="line">	echo $numTest</span><br><span class="line">	echo $stringTest</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<p>测试的ini配置档如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[General]</span><br><span class="line">ItemCount=2</span><br><span class="line">[Item0]</span><br><span class="line">NumTest=100</span><br><span class="line">StringTest=for string test 0</span><br><span class="line">[Item1]</span><br><span class="line">NumTest=111</span><br><span class="line">StringTest=for string test 1</span><br></pre></td></tr></table></figure>
<p>测试结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">2</span><br><span class="line">Item0</span><br><span class="line">100</span><br><span class="line">for string test 0</span><br><span class="line">Item1</span><br><span class="line">111</span><br><span class="line">for string test 1</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhanghongtong.github.io/2018/07/07/golang-生成随机数，时间种子改进型/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张奇怪">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张奇怪的blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/07/golang-生成随机数，时间种子改进型/" itemprop="url">golang 生成随机数，时间种子改进型</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-07-07T17:29:55+08:00">
                2018-07-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/golang/" itemprop="url" rel="index">
                    <span itemprop="name">golang</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">var (</span><br><span class="line">   randSeek = int64(1)</span><br><span class="line">   l        sync.Mutex</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">//获取指定长度的随机字符串</span><br><span class="line">//@params num int 生成的随机字符串的长度</span><br><span class="line">//@params str string 可选，指定随机的字符串</span><br><span class="line">func GetRandomSring(num int, str ...string) string &#123;</span><br><span class="line">   s := &quot;abcdefghijklmnopqrstuvwxyz0123456789&quot;</span><br><span class="line">   if len(str) &gt; 0 &#123;</span><br><span class="line">      s = str[0]</span><br><span class="line">   &#125;</span><br><span class="line">   l := len(s)</span><br><span class="line">   r := rand.New(rand.NewSource(getRandSeek()))</span><br><span class="line">   var buf bytes.Buffer</span><br><span class="line">   for i := 0; i &lt; num; i++ &#123;</span><br><span class="line">      x := r.Intn(l)</span><br><span class="line">      buf.WriteString(s[x : x+1])</span><br><span class="line">   &#125;</span><br><span class="line">   return buf.String()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func getRandSeek() int64 &#123;</span><br><span class="line">   l.Lock()</span><br><span class="line">   if randSeek &gt;= 100000000 &#123;</span><br><span class="line">      randSeek = 1</span><br><span class="line">   &#125;</span><br><span class="line">   randSeek++</span><br><span class="line">   l.Unlock()</span><br><span class="line">   return time.Now().UnixNano() + randSeek</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhanghongtong.github.io/2018/07/04/golang-map数据结构不能并发读写问题-fatal-error-concurrent-map-writes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张奇怪">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张奇怪的blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/04/golang-map数据结构不能并发读写问题-fatal-error-concurrent-map-writes/" itemprop="url">golang map数据结构不能并发读写问题 fatal error: concurrent map writes</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-07-04T14:46:35+08:00">
                2018-07-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/golang/" itemprop="url" rel="index">
                    <span itemprop="name">golang</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>go提供了一种叫map的数据结构，可以翻译成映射，对应于其他语言的字典、哈希表。借助map，可以定义一个键和值，然后可以从map中获取、设置和删除这个值，尤其适合数据查找的场景。但是map的使用有一定的限制，如果是在单个协程中读写map，那么不会存在什么问题，如果是多个协程并发访问一个map，有可能会导致程序退出，并打印下面错误信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fatal error: concurrent map read and map write</span><br></pre></td></tr></table></figure>
<p>上面的这个错误不是每次都会遇到的，如果并发访问的协程数不大，遇到的可能性就更小了。例如下面的程序：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    Map := make(map[int]int)</span><br><span class="line"></span><br><span class="line">    for i := 0; i &lt; 10; i++ &#123;</span><br><span class="line">        go writeMap(Map, i, i)</span><br><span class="line">        go readMap(Map, i)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func readMap(Map map[int]int, key int) int &#123;</span><br><span class="line">    return Map[key]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func writeMap(Map map[int]int, key int, value int) &#123;</span><br><span class="line">    Map[key] = value</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>只循环了10次，产生了20个协程并发访问map，程序基本不会出错，但是如果将循环次数变大，比如10万，运行下面程序基本每次都会出错：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    Map := make(map[int]int)</span><br><span class="line"></span><br><span class="line">    for i := 0; i &lt; 100000; i++ &#123;</span><br><span class="line">        go writeMap(Map, i, i)</span><br><span class="line">        go readMap(Map, i)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func readMap(Map map[int]int, key int) int &#123;</span><br><span class="line">    return Map[key]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func writeMap(Map map[int]int, key int, value int) &#123;</span><br><span class="line">    Map[key] = value</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="https://link.jianshu.com?t=https://blog.golang.org/go-maps-in-action" target="_blank" rel="noopener">go官方博客</a>有如下说明：</p>
<blockquote>
<p>Maps are not safe for concurrent use: it’s not defined what happens when you read and write to them simultaneously. If you need to read from and write to a map from concurrently executing goroutines, the accesses must be mediated by some kind of synchronization mechanism. One common way to protect maps is with sync.RWMutex.</p>
</blockquote>
<p><a href="https://link.jianshu.com?t=https://golang.org/doc/faq#atomic_maps" target="_blank" rel="noopener">go FAQ</a>解释如下：</p>
<blockquote>
<p>After long discussion it was decided that the typical use of maps did not require safe access from multiple goroutines, and in those cases where it did, the map was probably part of some larger data structure or computation that was already synchronized. Therefore requiring that all map operations grab a mutex would slow down most programs and add safety to few. This was not an easy decision, however, since it means uncontrolled map access can crash the program.</p>
</blockquote>
<p>大致意思就是说，并发访问map是不安全的，会出现未定义行为，导致程序退出。所以如果希望在多协程中并发访问map，必须提供某种同步机制，一般情况下通过读写锁sync.RWMutex实现对map的并发访问控制，将map和sync.RWMutex封装一下，可以实现对map的安全并发访问，示例代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import &quot;sync&quot;</span><br><span class="line"></span><br><span class="line">type SafeMap struct &#123;</span><br><span class="line">    sync.RWMutex</span><br><span class="line">    Map map[int]int</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    safeMap := newSafeMap(10)</span><br><span class="line"></span><br><span class="line">    for i := 0; i &lt; 100000; i++ &#123;</span><br><span class="line">        go safeMap.writeMap(i, i)</span><br><span class="line">        go safeMap.readMap(i)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func newSafeMap(size int) *SafeMap &#123;</span><br><span class="line">    sm := new(SafeMap)</span><br><span class="line">    sm.Map = make(map[int]int)</span><br><span class="line">    return sm</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (sm *SafeMap) readMap(key int) int &#123;</span><br><span class="line">    sm.RLock()</span><br><span class="line">    value := sm.Map[key]</span><br><span class="line">    sm.RUnlock()</span><br><span class="line">    return value</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (sm *SafeMap) writeMap(key int, value int) &#123;</span><br><span class="line">    sm.Lock()</span><br><span class="line">    sm.Map[key] = value</span><br><span class="line">    sm.Unlock()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是通过读写锁控制map的并发访问时，会导致一定的性能问题，不过能保证程序的安全运行，牺牲点性能问题是可以的。</p>
<p>本文来自：<a href="https://www.jianshu.com/p/10a998089486" target="_blank" rel="noopener">go语言坑之并发访问map</a>，感谢作者：<a href="https://www.jianshu.com/u/b2075cf393f8" target="_blank" rel="noopener">songleo</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhanghongtong.github.io/2018/07/04/golang基础-互斥锁、读写锁/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张奇怪">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张奇怪的blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/04/golang基础-互斥锁、读写锁/" itemprop="url">golang基础-互斥锁、读写锁</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-07-04T14:37:06+08:00">
                2018-07-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/golang/" itemprop="url" rel="index">
                    <span itemprop="name">golang</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="互斥锁"><a href="#互斥锁" class="headerlink" title="互斥锁"></a><strong>互斥锁</strong></h4><p>其中Mutex为互斥锁，Lock()加锁，Unlock()解锁，使用Lock()加锁后，便不能再次对其进行加锁，直到利用Unlock()解锁对其解锁后，才能再次加锁．<strong>适用于读写不确定场景，即读写次数没有明显的区别，并且只允许只有一个读或者写的场景，所以该锁叶叫做全局锁。</strong><br>func (m *Mutex) Unlock()用于解锁m，如果在使用Unlock()前未加锁，就会引起一个运行错误．已经锁定的Mutex并不与特定的goroutine相关联，这样可以利用一个goroutine对其加锁，再利用其他goroutine对其解锁。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import(</span><br><span class="line">    &quot;fmt&quot;</span><br><span class="line">    &quot;time&quot;</span><br><span class="line">    &quot;sync&quot;</span><br><span class="line">    &quot;math/rand&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">var lock sync.Mutex</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line"></span><br><span class="line">    testMap()</span><br><span class="line">&#125;</span><br><span class="line">func testMap() &#123;</span><br><span class="line">    var a map[int]int</span><br><span class="line">    a = make(map[int]int, 5)</span><br><span class="line"></span><br><span class="line">    a[8] = 10</span><br><span class="line">    a[3] = 10</span><br><span class="line">    a[2] = 10</span><br><span class="line">    a[1] = 10</span><br><span class="line">    a[18] = 10</span><br><span class="line"></span><br><span class="line">    for i := 0; i &lt; 2; i++ &#123;</span><br><span class="line">        go func(b map[int]int) &#123;</span><br><span class="line">            lock.Lock()</span><br><span class="line">            b[8] = rand.Intn(100)</span><br><span class="line">            lock.Unlock()</span><br><span class="line">        &#125;(a)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    lock.Lock()</span><br><span class="line">    fmt.Println(a)</span><br><span class="line">    lock.Unlock()</span><br><span class="line"></span><br><span class="line">    time.Sleep(time.Second)</span><br><span class="line">    fmt.Println(a)</span><br><span class="line">&#125;12345678910111213141516171819202122232425262728293031323334353637383940</span><br></pre></td></tr></table></figure>
<p>输出如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PS E:\golang\go_pro\src\safly&gt; go run demo.go</span><br><span class="line">map[3:10 2:10 1:10 18:10 8:10]</span><br><span class="line">map[2:10 1:10 18:10 8:87 3:10]</span><br><span class="line">PS E:\golang\go_pro\src\safly&gt;1234</span><br></pre></td></tr></table></figure>
<p>我们利用了time.Sleep(time.Second)这个进行的延迟，goroute执行完毕，就进行输出，结果是进行了map的修改</p>
<h4 id="读写锁"><a href="#读写锁" class="headerlink" title="读写锁"></a><strong>读写锁</strong></h4><p>读写锁实际是一种特殊的自旋锁，它把对共享资源的访问者划分成读者和写者，读者只对共享资源进行读访问，写者则需要对共享资源进行写操作<strong>。这种锁相对于自旋锁而言，能提高并发性，</strong>因为在多处理器系统中，它允许同时有多个读者来访问共享资源，最大可能的读者数为实际的逻辑CPU数。<strong>写者是排他性的，一个读写锁同时只能有一个写者或多个读者（与CPU数相关），但不能同时既有读者又有写者。</strong></p>
<p>1、可以随便读，多个goroutine同时读</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import(</span><br><span class="line">    // &quot;fmt&quot;</span><br><span class="line">    &quot;time&quot;</span><br><span class="line">    &quot;sync&quot;</span><br><span class="line"></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">var m *sync.RWMutex</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    m = new(sync.RWMutex)</span><br><span class="line"></span><br><span class="line">    // 多个同时读</span><br><span class="line">    go read(1)</span><br><span class="line">    go read(2)</span><br><span class="line"></span><br><span class="line">    time.Sleep(2*time.Second)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func read(i int) &#123;</span><br><span class="line">    println(i,&quot;read start&quot;)</span><br><span class="line"></span><br><span class="line">    m.RLock()</span><br><span class="line">    println(i,&quot;reading&quot;)</span><br><span class="line">    time.Sleep(1*time.Second)</span><br><span class="line">    m.RUnlock()    </span><br><span class="line"></span><br><span class="line">    println(i,&quot;read over&quot;)</span><br><span class="line">&#125;12345678910111213141516171819202122232425262728293031</span><br></pre></td></tr></table></figure>
<p>输出如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PS E:\golang\go_pro\src\safly&gt; go run demo.go</span><br><span class="line">1 read start</span><br><span class="line">1 reading</span><br><span class="line">1 read over</span><br><span class="line">2 read start</span><br><span class="line">2 reading</span><br><span class="line">2 read over1234567</span><br></pre></td></tr></table></figure>
<p>可以看出1 读还没有结束，2已经在读</p>
<p>本文来自：<a href="https://blog.csdn.net/u013210620/article/details/78357995" target="_blank" rel="noopener">golang基础-互斥锁、读写锁</a>，感谢作者：<a href="https://blog.csdn.net/u013210620" target="_blank" rel="noopener">Safly</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhanghongtong.github.io/2018/07/04/如何优雅的控制goroutine的数量/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张奇怪">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张奇怪的blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/04/如何优雅的控制goroutine的数量/" itemprop="url">如何优雅的控制goroutine的数量</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-07-04T14:29:09+08:00">
                2018-07-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/golang/" itemprop="url" rel="index">
                    <span itemprop="name">golang</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>1,为什么要控制goroutine的数量？</strong>     goroutine固然好，但是数量太多了，往往会带来很多麻烦，比如耗尽系统资源导致程序崩溃，或者CPU使用率过高导致系统忙不过来。比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">for i:=0; i &lt; 10000; i++ &#123;</span><br><span class="line">    go work()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>2,用什么方法控制goroutine的数量？</strong> 要在每一次执行go之前判断goroutine的数量，如果数量超了，就要阻塞go的执行。第一时间想到的就是使用通道。每次执行的go之前向通道写入值，直到通道满的时候就阻塞了，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">var ch chan int</span><br><span class="line"></span><br><span class="line">func work() &#123;</span><br><span class="line">    //do something</span><br><span class="line">    &lt;-ch</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    ch = make(chan int, 10)</span><br><span class="line">    for i:=0; i &lt; 10000; i++ &#123;</span><br><span class="line">       ch &lt;- 1</span><br><span class="line">       go work()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样每次同时运行的goroutine就被限制为10个了。但是新的问题出现了，因为并不是所有的goroutine都执行完了，在main函数退出之后，还有一些goroutine没有执行完就被强制结束了。这个时候我们就需要用到sync.WaitGroup。使用WaitGroup等待所有的goroutine退出。如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">var wg *sync.WaitGroup</span><br><span class="line"></span><br><span class="line">func work() &#123;</span><br><span class="line">    defer wg.Done()</span><br><span class="line">    //do something</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    wg = &amp;sync.WaitGroup&#123;&#125;</span><br><span class="line">    for i:=0; i &lt; 10000; i++ &#123;</span><br><span class="line">       wg.Add(1)</span><br><span class="line">       go work()</span><br><span class="line">    &#125;</span><br><span class="line">    wg.Wait()//等待所有goroutine退出</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>3,优雅的使用并控制goroutine的数量</strong> 综上所述，我们封装一下，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">package gpool</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&quot;sync&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">type pool struct &#123;</span><br><span class="line">	queue chan int</span><br><span class="line">	wg    *sync.WaitGroup</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func New(size int) *pool &#123;</span><br><span class="line">	if size &lt;= 0 &#123;</span><br><span class="line">		size = 1</span><br><span class="line">	&#125;</span><br><span class="line">	return &amp;pool&#123;</span><br><span class="line">		queue: make(chan int, size),</span><br><span class="line">		wg:    &amp;sync.WaitGroup&#123;&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (p *pool) Add(delta int) &#123;</span><br><span class="line">	for i := 0; i &lt; delta; i++ &#123;</span><br><span class="line">		p.queue &lt;- 1</span><br><span class="line">	&#125;</span><br><span class="line">	for i := 0; i &gt; delta; i-- &#123;</span><br><span class="line">		&lt;-p.queue</span><br><span class="line">	&#125;</span><br><span class="line">	p.wg.Add(delta)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (p *pool) Done() &#123;</span><br><span class="line">	&lt;-p.queue</span><br><span class="line">	p.wg.Done()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (p *pool) Wait() &#123;</span><br><span class="line">	p.wg.Wait()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>来段测试代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">package gpool_test</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&quot;runtime&quot;</span><br><span class="line">	&quot;testing&quot;</span><br><span class="line">	&quot;time&quot;</span><br><span class="line">	&quot;gpool&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func Test_Example(t *testing.T) &#123;</span><br><span class="line">	pool := gpool.New(100)</span><br><span class="line">	println(runtime.NumGoroutine())</span><br><span class="line">	for i := 0; i &lt; 1000; i++ &#123;</span><br><span class="line">		pool.Add(1)</span><br><span class="line">		go func() &#123;</span><br><span class="line">			time.Sleep(time.Second)</span><br><span class="line">			println(runtime.NumGoroutine())</span><br><span class="line">			pool.Done()</span><br><span class="line">		&#125;()</span><br><span class="line">	&#125;</span><br><span class="line">	pool.Wait()</span><br><span class="line">	println(runtime.NumGoroutine())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>good job，Over～</p>
<p>本文来自：<a href="https://my.oschina.net/xlplbo/blog/682884?fromerr=l7bPLR8G" target="_blank" rel="noopener">如何优雅的控制goroutine的数量</a>，感谢作者：<a href="https://my.oschina.net/xlplbo" target="_blank" rel="noopener">borey</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhanghongtong.github.io/2018/06/26/将Golang应用部署到Docker/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张奇怪">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张奇怪的blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/26/将Golang应用部署到Docker/" itemprop="url">将Golang应用部署到Docker</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-06-26T16:43:10+08:00">
                2018-06-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/docker/" itemprop="url" rel="index">
                    <span itemprop="name">docker</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="一、编写Dockerfile"><a href="#一、编写Dockerfile" class="headerlink" title="一、编写Dockerfile"></a>一、编写Dockerfile</h3><p>在 <code>go-example</code> 项目根目录创建 Dockerfile 文件，写入内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">FROM golang:latest</span><br><span class="line"></span><br><span class="line">WORKDIR $GOPATH/src/go-example	</span><br><span class="line">COPY . $GOPATH/src/go-example</span><br><span class="line">RUN go build .</span><br><span class="line"></span><br><span class="line">EXPOSE 8000</span><br><span class="line"></span><br><span class="line">ENTRYPOINT [&quot;./go-example&quot;]</span><br></pre></td></tr></table></figure>
<h4 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h4><p>1.Dockerfile命名必须为“Dockerfile”，Docker镜像构建时，会查找指定目录中的Dockerfile。</p>
<p>2.将Dockerfile创建在项目根目录，方便COPY命令负责上下文</p>
<h4 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h4><p><code>golang:latest</code> 镜像为基础镜像，将工作目录设置为 <code>$GOPATH/src/go-example</code>，并将当前上下文目录的内容复制到 <code>$GOPATH/src/go-example</code> 中</p>
<p>在进行 <code>go build</code> 编译完毕后，将容器启动程序设置为 <code>./go-example</code>，也就是我们所编译的可执行文件</p>
<p>注意 <code>go-example</code> 在 <code>docker</code> 容器里编译，并没有在宿主机现场编译</p>
<h4 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h4><p>Dockerfile 文件是用于定义 Docker 镜像生成流程的配置文件，文件内容是一条条指令，每一条指令构建一层，因此每一条指令的内容，就是描述该层应当如何构建；这些指令应用于基础镜像并最终创建一个新的镜像</p>
<p>你可以认为用于快速创建自定义的 Docker 镜像</p>
<p><strong>1、 FROM</strong></p>
<p>指定基础镜像（必须有的指令，并且必须是第一条指令）</p>
<p><strong>2、 WORKDIR</strong></p>
<p>格式为 <code>WORKDIR</code> &lt;工作目录路径&gt;</p>
<p>使用 <code>WORKDIR</code> 指令可以来<strong>指定工作目录</strong>（或者称为当前目录），以后各层的当前目录就被改为指定的目录，如果目录不存在，<code>WORKDIR</code> 会帮你建立目录</p>
<p><strong>3、COPY</strong></p>
<p>格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">COPY &lt;源路径&gt;... &lt;目标路径&gt;</span><br><span class="line">COPY [&quot;&lt;源路径1&gt;&quot;,... &quot;&lt;目标路径&gt;&quot;]</span><br></pre></td></tr></table></figure>
<p><code>COPY</code> 指令将从构建上下文目录中 &lt;源路径&gt; 的文件/目录<strong>复制</strong>到新的一层的镜像内的 &lt;目标路径&gt; 位置</p>
<p><strong>4、RUN</strong></p>
<p>用于执行命令行命令</p>
<p>格式：<code>RUN</code> &lt;命令&gt;</p>
<p><strong>5、EXPOSE</strong></p>
<p>格式为 <code>EXPOSE</code> &lt;端口1&gt; [&lt;端口2&gt;…]</p>
<p><code>EXPOSE</code> 指令是<strong>声明运行时容器提供服务端口，这只是一个声明</strong>，在运行时并不会因为这个声明应用就会开启这个端口的服务</p>
<p>在 Dockerfile 中写入这样的声明有两个好处</p>
<ul>
<li>帮助镜像使用者理解这个镜像服务的守护端口，以方便配置映射</li>
<li>运行时使用随机端口映射时，也就是 <code>docker run -P</code> 时，会自动随机映射 <code>EXPOSE</code> 的端口</li>
</ul>
<p><strong>6、ENTRYPOINT</strong></p>
<p><code>ENTRYPOINT</code> 的格式和 <code>RUN</code> 指令格式一样，分为两种格式</p>
<ul>
<li><code>exec</code> 格式：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;ENTRYPOINT&gt; &quot;&lt;CMD&gt;&quot;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>shell</code> 格式：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ENTRYPOINT [ &quot;curl&quot;, &quot;-s&quot;, &quot;http://ip.cn&quot; ]</span><br></pre></td></tr></table></figure>
<p><code>ENTRYPOINT</code> 指令是<strong>指定容器启动程序及参数</strong></p>
<h3 id="二、构建镜像"><a href="#二、构建镜像" class="headerlink" title="二、构建镜像"></a>二、构建镜像</h3><p><code>go-example</code> 的项目根目录下<strong>执行</strong> <code>docker build -t imageName .</code></p>
<p>该命令作用是创建/构建镜像，<code>-t</code> 指定镜像名称，<code>.</code> 构建内容为当前上下文目录</p>
<p>构建完成后使用<code>docker images</code> 命令查看</p>
<h3 id="三、创建并运行一个新容器"><a href="#三、创建并运行一个新容器" class="headerlink" title="三、创建并运行一个新容器"></a>三、创建并运行一个新容器</h3><p>执行命令 <code>docker run -d -p 8000:8000 imageName</code> 启动容器，可以使用<code>-d</code>参数来使容器保持后台运行，貌似可以替代掉<code>supervisorctl</code> 的作用，还未在生产环境中使用过，并不确定</p>
<h3 id="四、修改Dockerfile"><a href="#四、修改Dockerfile" class="headerlink" title="四、修改Dockerfile"></a>四、修改Dockerfile</h3><p>直接使用 <code>docker</code> 在后台运行 <code>golang</code> 程序的话就没有 <code>supervisorctl</code> 的日志功能了，我们可以使用 <code>golang</code> 的 <code>log</code> 包配合 <code>Dockerfile</code> 来实现日志功能</p>
<p><code>golang</code> 代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&quot;log&quot;</span><br><span class="line">	&quot;os&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main()&#123;</span><br><span class="line">  	fileName := &quot;/var/log/timerTisk/error.log&quot;	//定义日志文件</span><br><span class="line">    logFile,err  := os.Create(fileName)		</span><br><span class="line">    defer logFile.Close()</span><br><span class="line">    if err != nil &#123;</span><br><span class="line">    	log.Fatalln(&quot;open file error&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">    debugLog := log.New(logFile,&quot;[Error]&quot;,log.Llongfile)</span><br><span class="line">    debugLog.Println(reqinfo)		//输入错误到日志文件</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Dockerfile</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">FROM golang:latest</span><br><span class="line"></span><br><span class="line">#创建日志文件并赋予权限</span><br><span class="line">RUN mkdir -p /var/log/go-example</span><br><span class="line">RUN touch /var/log/go-example/error.log</span><br><span class="line">RUN chmod 777 /var/log/go-example/error.log</span><br><span class="line"></span><br><span class="line">#设置时区</span><br><span class="line">ENV TZ=Asia/Shanghai</span><br><span class="line">RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime &amp;&amp; echo $TZ &gt; /etc/timezone</span><br><span class="line"></span><br><span class="line">WORKDIR $GOPATH/src/go-example	</span><br><span class="line">COPY . $GOPATH/src/go-example</span><br><span class="line">RUN go build .</span><br><span class="line"></span><br><span class="line">EXPOSE 8000</span><br><span class="line"></span><br><span class="line">ENTRYPOINT [&quot;./go-example&quot;]</span><br></pre></td></tr></table></figure>
<p>构建镜像后使用命令 <code>docker run -d -p 8000:8000 -v /var/log/go-example:/var/log/go-example imageName</code> 来运行服务，就可以去宿主机的相关目录查看日志文件了。</p>
<h3 id="五、推荐使用Docker-Compose-来部署服务"><a href="#五、推荐使用Docker-Compose-来部署服务" class="headerlink" title="五、推荐使用Docker Compose 来部署服务"></a>五、推荐使用Docker Compose 来部署服务</h3><p>目前使用阿里云容器服务的编排模板功能也可以实现，暂时就先不做相关实验了。</p>
<h3 id="六、一点疑惑"><a href="#六、一点疑惑" class="headerlink" title="六、一点疑惑"></a>六、一点疑惑</h3><p>每次更新了 <code>Dockerfile</code> 之后都要 <code>docker build</code> 来构建新的镜像，然后再重新部署相关服务貌似有点不够优雅，除非使用蓝绿发布的策略不然也达不到生产中热更新的要求，暂时没找到有什么方法更优雅的实现</p>
<h3 id="七、资料参考"><a href="#七、资料参考" class="headerlink" title="七、资料参考"></a>七、资料参考</h3><p><a href="https://segmentfault.com/a/1190000013960558#articleHeader5" target="_blank" rel="noopener">Gin实践 连载九 将Golang应用部署到Docker</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhanghongtong.github.io/2018/06/20/nginx报错upstream-timed-out-110-Connection-timed-out-while-reading-response-header-from-upstream-的解决方案/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张奇怪">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张奇怪的blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/20/nginx报错upstream-timed-out-110-Connection-timed-out-while-reading-response-header-from-upstream-的解决方案/" itemprop="url">nginx报错upstream timed out (110: Connection timed out) while reading response header from upstream..的解决方案</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-06-20T20:28:54+08:00">
                2018-06-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/服务器/" itemprop="url" rel="index">
                    <span itemprop="name">服务器</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Nginx报错日志有如下内容：</p>
<p><code>upstream timed out (110: Connection timed out) while reading response header from upstream..</code></p>
<p>服务器开发环境：<code>docker + nginx  + php-fpm</code></p>
<p>请求PHP页面，浏览器一直处在加载状态，页面阻塞，没有任何反应；</p>
<p>网上很多资料，大意是修改nginx配置文件，延长fastcgi等待时间，但不能解决根本问题。</p>
<p>经测试，问题出在php-fpm，php代码要使用file存取session,读写数据库，其中有一项操作缓慢，都能造成nginx假死；</p>
<p>解决方案：</p>
<p>新建php-fpm慢日志：</p>
<p><code>#mkdir /var/log/php-fpm &amp;&amp; chown www-data:www-data /var/log/php-fpm</code></p>
<p>打开php-fpm的配置文件</p>
<p><code>#vim /usr/local/etc/php-fpm.d/www.conf</code></p>
<p>修改：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">request_slowlog_timeout = 2s</span><br><span class="line">request_terminate_timeout = 30s</span><br><span class="line">slowlog = /var/log/php-fpm/$pool.log.slow</span><br></pre></td></tr></table></figure>
<p>重启nginx和php-fpm</p>
<p>刷新页面，页面一直停留在阻塞状态，没有反应，这时，</p>
<p><code>tailf  /var/log/php-fpm/www.log.slow</code></p>
<p>可以清楚看到执行慢的语句和操作，这样就能找到具体原因！</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhanghongtong.github.io/2018/06/15/docker-php添加redis扩展/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张奇怪">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张奇怪的blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/15/docker-php添加redis扩展/" itemprop="url">docker-php添加redis扩展</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-06-15T17:12:35+08:00">
                2018-06-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/服务器/" itemprop="url" rel="index">
                    <span itemprop="name">服务器</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>使用Docker File 创建php的镜像，并添加redis扩展</p>
<h3 id="1、创建一个Dockerfile"><a href="#1、创建一个Dockerfile" class="headerlink" title="1、创建一个Dockerfile"></a>1、创建一个Dockerfile</h3><p>Dockerfile命名必须为“Dockerfile”，Docker镜像构建时，会查找指定目录中的Dockerfile。</p>
<h3 id="2、编写Dockerfile"><a href="#2、编写Dockerfile" class="headerlink" title="2、编写Dockerfile"></a>2、编写Dockerfile</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">#引用镜像</span><br><span class="line">FROM php:5.6-fpm</span><br><span class="line"></span><br><span class="line">RUN apt-get update</span><br><span class="line"></span><br><span class="line">RUN docker-php-ext-install mbstring opcache pdo pdo_mysql mysql mysqli</span><br><span class="line"></span><br><span class="line">#添加redis</span><br><span class="line">ENV PHPREDIS_VERSION 3.1.3</span><br><span class="line">RUN curl -L -o /tmp/redis.tar.gz https://github.com/phpredis/phpredis/archive/$PHPREDIS_VERSION.tar.gz \</span><br><span class="line">    &amp;&amp; tar xfz /tmp/redis.tar.gz \</span><br><span class="line">    &amp;&amp; rm -r /tmp/redis.tar.gz \</span><br><span class="line">    &amp;&amp; mkdir -p /usr/src/php/ext \</span><br><span class="line">    &amp;&amp; mv phpredis-$PHPREDIS_VERSION /usr/src/php/ext/redis \</span><br><span class="line">    &amp;&amp; docker-php-ext-install redis \</span><br><span class="line">    &amp;&amp; rm -rf /usr/src/phpG</span><br><span class="line">    </span><br><span class="line">#安装php composer</span><br><span class="line">RUN php -r &quot;copy(&apos;https://getcomposer.org/installer&apos;, &apos;composer-setup.php&apos;);&quot;</span><br><span class="line">RUN php -r &quot;if (hash_file(&apos;SHA384&apos;, &apos;composer-setup.php&apos;) === &apos;544e09ee996cdf60ece3804abc52599c22b1f40f4323403c44d44fdfdd586475ca9813a858088ffbc1f233e9b180f061&apos;) &#123; echo &apos;Installer verified&apos;; &#125; else &#123; echo &apos;Installer corrupt&apos;; unlink(&apos;composer-setup.php&apos;); &#125; echo PHP_EOL;&quot;</span><br><span class="line">RUN php composer-setup.php --install-dir=/bin --filename=composer</span><br><span class="line"></span><br><span class="line">#设置工作目录</span><br><span class="line">WORKDIR /home/www-data</span><br></pre></td></tr></table></figure>
<h3 id="3-构建镜像"><a href="#3-构建镜像" class="headerlink" title="3.构建镜像"></a>3.构建镜像</h3><p>进入Dockerfile所在目录，运行命令 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t ImageName .</span><br></pre></td></tr></table></figure>
<p>(注意最后有个点用来表示当前目录，初次构建速度会比较慢，需要多等一会。)</p>
<h3 id="4-查看构建好的镜像"><a href="#4-查看构建好的镜像" class="headerlink" title="4.查看构建好的镜像"></a>4.查看构建好的镜像</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker images #查看镜像</span><br></pre></td></tr></table></figure>
<h3 id="5-一点问题"><a href="#5-一点问题" class="headerlink" title="5.一点问题"></a>5.一点问题</h3><p>使用本地的image创建出来的php的容器，没法与从阿里云的容器服务创建出来的nginx的容器一起工作，nginx会报超时的错误，但是把images上传只阿里云的镜像仓库，然后从容器服务控制台使用Docker Compose同时创建两个应用，就可以正常工作。怀疑是分批创建的时候两个应用不在一个网络环境中导致的。</p>
<h3 id="6-资料参考"><a href="#6-资料参考" class="headerlink" title="6.资料参考"></a>6.资料参考</h3><p><a href="https://github.com/helloMJW/docker-lnmp" target="_blank" rel="noopener">完整Dockerfile</a></p>
<p><a href="http://www.majianwei.com/docker-php%E6%B7%BB%E5%8A%A0redis%E6%89%A9%E5%B1%95/" target="_blank" rel="noopener">docker-php添加redis扩展</a></p>
<p><a href="https://my.oschina.net/antsky/blog/1591418" target="_blank" rel="noopener">Docker 中的 PHP 如何安装扩展</a></p>
<p><a href="http://dockone.io/article/1866" target="_blank" rel="noopener">Docker修炼第一招： 从Dockerfile开始</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhanghongtong.github.io/2018/06/14/使用docker安装nginx和php-fpm服务/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张奇怪">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张奇怪的blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/14/使用docker安装nginx和php-fpm服务/" itemprop="url">使用docker安装nginx和php-fpm服务</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-06-14T16:55:12+08:00">
                2018-06-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/服务器/" itemprop="url" rel="index">
                    <span itemprop="name">服务器</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>之前使用docker都是直接当做虚拟机来用，直接pull一个ubuntu的镜像，然后再里面安装各种服务。后来发现docker的正确用法应该是起多个容器，一个容器一个进程，包含程序相关的上下文，暂时拿最常用的nginx+php-fpm的服务来练手。</p>
<h3 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h3><p>应为生产环境一直使用的是阿里云的容器服务，懒得自己搭了，直接在阿里云的容器服务上继续试验</p>
<p>1、创建应用，Docker Compose的配置如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">php:</span><br><span class="line">  image: &apos;php:5.6-fpm&apos;		</span><br><span class="line">  volumes:</span><br><span class="line">    - &apos;/docker_test/www:/var/www:rw&apos;</span><br><span class="line">  mem_limit: 0</span><br><span class="line">  kernel_memory: 0</span><br><span class="line">  memswap_reservation: 0</span><br><span class="line">  restart: always</span><br><span class="line">  environment:</span><br><span class="line">        - &apos;constraint:aliyun.node_index==5&apos;</span><br><span class="line">  shm_size: 0</span><br><span class="line">  memswap_limit: 0</span><br><span class="line">  labels:</span><br><span class="line">    aliyun.scale: &apos;1&apos;</span><br><span class="line">  tty: true</span><br><span class="line">  </span><br><span class="line">nginx:</span><br><span class="line">  image: &apos;nginx:latest&apos;</span><br><span class="line">  volumes:</span><br><span class="line">    - &apos;/docker_test/www:/var/www:rw&apos;</span><br><span class="line">  ports:</span><br><span class="line">    - &apos;8090:80/tcp&apos;</span><br><span class="line">  mem_limit: 0</span><br><span class="line">  kernel_memory: 0</span><br><span class="line">  memswap_reservation: 0</span><br><span class="line">  restart: always</span><br><span class="line">  environment:</span><br><span class="line">        - &apos;constraint:aliyun.node_index==5&apos;</span><br><span class="line">  shm_size: 0</span><br><span class="line">  memswap_limit: 0</span><br><span class="line">  labels:</span><br><span class="line">    aliyun.scale: &apos;1&apos;</span><br><span class="line">  tty: true</span><br></pre></td></tr></table></figure>
<p>常规操作，没什么好说的，需要注意的是目前php在docker hub的最新镜像为7.2，本次先使用5.6-fpm的版本(貌似镜像有fpm和cil之分，拉取时需要注意)，另外两个容器都映射了<code>/var/www</code>目录。</p>
<p>2、使用 <code>docker ps -a</code> 命令查看创建的容器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># docker ps -a</span><br><span class="line">CONTAINER ID		IMAGE			COMMAND				CREATED					STATUS		PORTS				NAMES                                                                                                        a22c7473cd43        nginx:latest 	&quot;nginx -g &apos;daemon ...&quot;   6 hours ago         Up 6 hours          0.0.0.0:8090-&gt;80/tcp	test_nginx_1                                                                            </span><br><span class="line">b8273c6825f9        php:5.6-fpm    &quot;docker-php-entryp...&quot;   6 hours ago         Up 6 hours          9000/tcp               test_php_1</span><br></pre></td></tr></table></figure>
<p>可以看到成功的创建了两个容器，php-fpm的容器默认使用9000端口，可以使用端口映射到宿主机的其他端口，使用<code>docker inspect</code>命令查看php容器的内网IP，方便修改nginx的配置项</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># docker inspect test_php_1 | grep &quot;IPAddress&quot;     </span><br><span class="line">&quot;SecondaryIPAddresses&quot;: null,</span><br><span class="line">&quot;IPAddress&quot;: &quot;&quot;,</span><br><span class="line">&quot;IPAddress&quot;: &quot;172.18.0.5&quot;,</span><br></pre></td></tr></table></figure>
<p><code>docker inspect</code> 命令可以查看容器的详细信息，使用管道命令只输出IPAddress</p>
<p>3、修改nginx的相关配置</p>
<p>使用 <code>docker exec -it test_nginx_1 /bin/bash</code>  命令登录到容器内部，查看配置的相关文件，可以看到nginx的配置文件路径为  <code>/etc/nginx/conf.d/default.conf</code>和 <code>/etc/nginx/nginx.conf</code></p>
<p>在容器中是没有vim命令的，所以不能在容器中直接修改配置文件，可以将配置文件映射到宿主机目录编辑，或者使用docker cp命令将配置文件复制到宿主机进行编辑，这里使用docker cp命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#docker cp test_nginx_1:/etc/nginx/conf.d/default.conf ./default.conf</span><br></pre></td></tr></table></figure>
<p>编辑<code>default.conf</code>中php的部分</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">location ~ \.php$ &#123;</span><br><span class="line">        root           /var/www;</span><br><span class="line">        fastcgi_pass   172.18.0.5:9000;</span><br><span class="line">        fastcgi_index  index.php;</span><br><span class="line">        fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span><br><span class="line">       </span><br><span class="line">        include        fastcgi_params;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><code>fastcgi_pass</code>的配置为php容器的ip</p>
<p>保存后使用<code>docker cp</code>命令将配置文件复制回容器里，进入容器重新载入nginx</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#docker cp ./default.conf test_nginx_1:/etc/nginx/conf.d/default.conf</span><br><span class="line">#docker exec -it test_nginx_1 /bin/bash</span><br><span class="line">#nginx -s reload</span><br></pre></td></tr></table></figure>
<p>在宿主机<code>/docker_test/www</code>里面新建<code>test.php</code>，使用浏览器访问 <code>http://宿主机IP:8090/test.php</code>。应该可以正常访问了。</p>
<p>4、一点补充</p>
<p>实际测试中访问nginx发现报错 File not found，这个错误很常见，一般来说原因是下面两种</p>
<ol>
<li>php-fpm找不到SCRIPT_FILENAME里执行的php文件</li>
<li>php-fpm不能访问所执行的php，也就是权限问题</li>
</ol>
<p>针对第一种情况的话，编辑nginx的default.conf文件，将php配置中的<code>fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name</code>修改为<code>fastcgi_param   SCRIPT_FILENAME    $document_root$fastcgi_script_name;</code>就可以了</p>
<p>针对第二种情况，进入php的容器，找到php-fpm的配置文件，php5.6-fpm的镜像的话配置文件在 <code>/usr/local/etc/php-fpm.d/www.conf</code> 中，找到下面一行配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">; Unix user/group of processes</span><br><span class="line">; Note: The user is mandatory. If the group is not set, the default user&apos;s group</span><br><span class="line">;       will be used.</span><br><span class="line">user = www-data</span><br><span class="line">group = www-data</span><br></pre></td></tr></table></figure>
<p>修改.php文件的所属或者是修改配置文件中的这两个项目都可以，本次选择的是修改php文件的所属</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#chown —R www-data:www-data /var/www</span><br></pre></td></tr></table></figure>
<p>5、再补充一点</p>
<p>实际测试中发现nginx不产生日志文件，按照以前的思路怎么修改<code>nginx.conf</code>怎么都不行，后来发现需要修改<code>default.conf</code> ，看来nginx的镜像和ubuntu下直接安装的nginx还是有一定的区别的。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="张奇怪" />
          <p class="site-author-name" itemprop="name">张奇怪</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">39</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">18</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">张奇怪</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  





  

  

  

  

  

  

</body>
</html>
