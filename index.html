<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="简体中文">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta property="og:type" content="website">
<meta property="og:title" content="张奇怪的blog">
<meta property="og:url" content="https://zhanghongtong.github.io/index.html">
<meta property="og:site_name" content="张奇怪的blog">
<meta property="og:locale" content="简体中文">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="张奇怪的blog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://zhanghongtong.github.io/"/>





  <title>张奇怪的blog</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="简体中文">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">张奇怪的blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhanghongtong.github.io/2019/12/19/RPM-包的构建-SPEC-基础知识/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张奇怪">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张奇怪的blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/12/19/RPM-包的构建-SPEC-基础知识/" itemprop="url">RPM 包的构建 - SPEC 基础知识</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-12-19T16:55:52+08:00">
                2019-12-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/服务器/" itemprop="url" rel="index">
                    <span itemprop="name">服务器</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#<a href="https://www.cnblogs.com/michael-xiang/p/10480809.html" target="_blank" rel="noopener">RPM 包的构建 - SPEC 基础知识</a>             </p>
<h2 id="spec-文件"><a href="#spec-文件" class="headerlink" title="spec 文件"></a>spec 文件</h2><p>制作 rpm 软件包并不是一件复杂的工作，其中的关键在于编写软件包的 spec 描述文件。</p>
<p>要想制作一个 rpm 软件包就必须写一个软件包描述文件 spec。这个文件中包含了软件包的诸多信息，如：软件包的名字、版本、类别、说明摘要、创建时要执行什么指令、安装时要执行什么操作、以及软件包所要包含的文件列表等等。</p>
<p>实际过程中，最关键的地方，是要清楚虚拟路径的位置，以及宏的定义。</p>
<h2 id="文件头"><a href="#文件头" class="headerlink" title="文件头"></a>文件头</h2><p>这个区域定义的 <code>Name</code>、<code>Version</code> 这些字段对应的值可以在后面通过 <code>%{name}</code>,<code>%{version}</code> 这样的方式来引用，类似于 C 语言中的宏</p>
<ul>
<li><p><code>Summary</code>：用一句话概括该软件s包尽量多的信息。</p>
</li>
<li><p><code>Name</code>：软件包的名字，最终 rpm 软件包是用该名字与版本号（<code>Version</code>）、释出号(<code>Release</code>）及体系号来命名软件包的，后面可使用 <code>%{name}</code> 的方式引用</p>
</li>
<li><p><code>Version</code>：软件版本号。仅当软件包比以前有较大改变时才增加版本号，后面可使用<code>%{version}</code>引用</p>
</li>
<li><p><code>Release</code>：软件包释出号/发行号。一般我们对该软件包做了一些小的补丁的时候就应该把释出号加 1，后面可使用 <code>%{release}</code> 引用</p>
</li>
<li><p><code>Packager</code>：打包的人（一般喜欢写个人邮箱）</p>
</li>
<li><p><code>Vendor</code>：软件开发者的名字，发行商或打包组织的信息，例如<code>RedFlagCo,Ltd</code></p>
</li>
<li><p><code>License</code>：软件授权方式，通常是GPL（自由软件）或GPLv2,BSD</p>
</li>
<li><p><code>Copyright</code>：软件包所采用的版权规则。具体有：<code>GPL（自由软件）</code>，<code>BSD</code>，<code>MIT</code>，<code>Public Domain（公共域）</code>，<code>Distributable（贡献）</code>，<code>commercial（商业）</code>，<code>Share（共享）</code>等，一般的开发都写 <code>GPL</code>。</p>
</li>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Group</span><br></pre></td></tr></table></figure>
<p>：软件包所属类别</p>
<ul>
<li>Development/System （开发/系统）</li>
<li>System Environment/Daemons （系统环境/守护）</li>
</ul>
</li>
<li><p><code>Source</code>：源程序软件包的名字/源代码包的名字，如 <code>stardict-2.0.tar.gz</code>。可以带多个用 <code>Source1</code>、<code>Source2</code> 等源，后面也可以用 <code>%{source1}</code>、<code>%{source2}</code> 引用</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CopySource0: %&#123;name&#125;-boost-%&#123;version&#125;.tar.gz    ← 源码包名称(可以使用URL)，可以用SourceN指定多个，如配置文件</span><br><span class="line">#Patch0: some-bugs0.patch                    ← 如果需要打补丁，则依次填写</span><br><span class="line">#Patch1: some-bugs1.patch                    ← 如果需要打补丁，则依次填写</span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>BuildRequires</code>: 制作过程中用到的软件包，构建依赖</p>
</li>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Requires</span><br></pre></td></tr></table></figure>
<p>: 安装时所需软件包</p>
<ul>
<li><code>Requires(pre)</code>: 指定不同阶段的依赖</li>
</ul>
</li>
<li><p><code>BuildRoot</code>: 这个是安装或编译时使用的「虚拟目录」，打包时会用到该目录下文件，可查看安装后文件路径，例如：<code>BuildRoot:      %_topdir/BUILDROOT</code>。</p>
</li>
<li><p><code>Prefix: %{_prefix}</code> 这个主要是为了解决今后安装 rpm 包时，并不一定把软件安装到 rpm 中打包的目录的情况。这样，必须在这里定义该标识，并在编写 <code>%install</code> 脚本的时候引用，才能实现 rpm 安装时重新指定位置的功能</p>
</li>
<li><p><code>BuildArch</code>: 指编译的目标处理器架构，<code>noarch</code> 标识不指定，但通常都是以 <code>/usr/lib/rpm/marcros</code> 中的内容为默认值</p>
</li>
<li><p><code>%description</code>：软件包详细说明，可写在多个行上。这样任何人使用 <code>rpm -qi</code>查询您的软件包时都可以看到它。您可以解释这个软件包做什么，描述任何警告或附加的配置指令，等等。</p>
</li>
<li><p><code>URL</code>：软件的主页</p>
</li>
</ul>
<h3 id="RPM-包信息查看"><a href="#RPM-包信息查看" class="headerlink" title="RPM 包信息查看"></a>RPM 包信息查看</h3><p>我通过命令查看了 nginx 包的信息，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">Copy# 查看头部信息</span><br><span class="line"></span><br><span class="line">$ rpm -qpi ./nginx-1.12.2-2.el7.x86_64.rpm</span><br><span class="line">Name        : nginx</span><br><span class="line">Epoch       : 1</span><br><span class="line">Version     : 1.12.2</span><br><span class="line">Release     : 2.el7</span><br><span class="line">Architecture: x86_64</span><br><span class="line">Install Date: (not installed)</span><br><span class="line">Group       : System Environment/Daemons</span><br><span class="line">Size        : 1574949</span><br><span class="line">License     : BSD</span><br><span class="line">Signature   : RSA/SHA256, Tue 06 Mar 2018 05:44:06 PM CST, Key ID 6a2faea2352c64e5</span><br><span class="line">Source RPM  : nginx-1.12.2-2.el7.src.rpm</span><br><span class="line">Build Date  : Tue 06 Mar 2018 05:27:44 PM CST</span><br><span class="line">Build Host  : buildhw-02.phx2.fedoraproject.org</span><br><span class="line">Relocations : (not relocatable)</span><br><span class="line">Packager    : Fedora Project</span><br><span class="line">Vendor      : Fedora Project</span><br><span class="line">URL         : http://nginx.org/</span><br><span class="line">Bug URL     : https://bugz.fedoraproject.org/nginx</span><br><span class="line">Summary     : A high performance web server and reverse proxy server</span><br><span class="line">Description :</span><br><span class="line">Nginx is a web server and a reverse proxy server for HTTP, SMTP, POP3 and</span><br><span class="line">IMAP protocols, with a strong focus on high concurrency, performance and low</span><br><span class="line">memory usage.</span><br><span class="line"></span><br><span class="line"># 查看脚本内容</span><br><span class="line"></span><br><span class="line">$ rpm --scripts -qp ./nginx-1.12.2-2.el7.x86_64.rpm</span><br><span class="line">postinstall scriptlet (using /bin/sh):</span><br><span class="line"></span><br><span class="line">if [ $1 -eq 1 ] ; then</span><br><span class="line">        # Initial installation</span><br><span class="line">        systemctl preset nginx.service &gt;/dev/null 2&gt;&amp;1 || :</span><br><span class="line">fi</span><br><span class="line">preuninstall scriptlet (using /bin/sh):</span><br><span class="line"></span><br><span class="line">if [ $1 -eq 0 ] ; then</span><br><span class="line">        # Package removal, not upgrade</span><br><span class="line">        systemctl --no-reload disable nginx.service &gt; /dev/null 2&gt;&amp;1 || :</span><br><span class="line">        systemctl stop nginx.service &gt; /dev/null 2&gt;&amp;1 || :</span><br><span class="line">fi</span><br><span class="line">postuninstall scriptlet (using /bin/sh):</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload &gt;/dev/null 2&gt;&amp;1 || :</span><br><span class="line"></span><br><span class="line">if [ $1 -ge 1 ]; then</span><br><span class="line">    /usr/bin/nginx-upgrade &gt;/dev/null 2&gt;&amp;1 || :</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<h3 id="RPM-包依赖"><a href="#RPM-包依赖" class="headerlink" title="RPM 包依赖"></a>RPM 包依赖</h3><p>依赖关系定义了一个包正常工作需要依赖的其他包，RPM在升级、安装和删除的时候会确保依赖关系得到满足。</p>
<h4 id="BuildRequires"><a href="#BuildRequires" class="headerlink" title="BuildRequires"></a>BuildRequires</h4><p>定义构建时依赖的软件包，在构建机器编译 rpm 包时需要的辅助工具，以逗号分隔。</p>
<p>假如，要求编译 <code>myapp</code> 时，gcc 的版本至少为 4.4.2，则可以写成 <code>gcc &gt;=4.2.2</code></p>
<h4 id="Requires"><a href="#Requires" class="headerlink" title="Requires"></a>Requires</h4><p>定义安装时的依赖包，该 rpm 包所依赖的软件包名称，就是指编译好的 rpm 软件在其他机器上安装时，需要依赖的其他软件包。</p>
<p>可以用 <code>&gt;=</code> 或 <code>&lt;=</code> 表示大于或小于某一特定版本。 <code>&gt;=</code> 号两边需用空格隔开，而不同软件名称也用空格分开。</p>
<p>格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CopyRequires:       libpng-devel &gt;= 1.0.20 zlib</span><br></pre></td></tr></table></figure>
<p>其它写法例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CopyRequires: bzip2 = %&#123;version&#125;, bzip2-libs =%&#123;version&#125;</span><br></pre></td></tr></table></figure>
<p>还有例如<code>PreReq</code>、<code>Requires(pre)</code>、<code>Requires(post)</code>、<code>Requires(preun)</code>、<code>Requires(postun)</code>、<code>BuildRequires</code>等都是针对不同阶段的依赖指定。</p>
<p>关于<code>pre</code>、<code>post</code>、<code>preun</code>、<code>postun</code>含义理解，感觉<code>post</code>有一种“完成”的意思：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Copy# 安装前执行的脚本，语法和shell脚本的语法相同</span><br><span class="line">%pre</span><br><span class="line"># 安装后执行的脚本</span><br><span class="line">%post</span><br><span class="line"># 卸载前执行的脚本</span><br><span class="line">%preun</span><br><span class="line"># 卸载完成后执行的脚本</span><br><span class="line">%postun</span><br><span class="line"># 清理阶段，在制作完成后删除安装的内容</span><br></pre></td></tr></table></figure>
<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CopyPreReq: capability&gt;=version      #capability包必须先安装</span><br><span class="line">Conflicts:bash&gt;=2.0              #该包和所有不小于2.0的bash包有冲突</span><br></pre></td></tr></table></figure>
<h3 id="BuildRoot"><a href="#BuildRoot" class="headerlink" title="BuildRoot"></a>BuildRoot</h3><p>该参数非常重要，因为在生成 rpm 的过程中，执行 <code>make install</code> 时就会把软件安装到上述的路径中，在打包的时候，同样依赖“虚拟目录”为“根目录”进行操作。后面可使用 <code>$RPM_BUILD_ROOT</code> 方式引用。</p>
<p>考虑到多用户的环境，一般定义为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Copy%&#123;_tmppath&#125;/%&#123;name&#125;-%&#123;version&#125;-%&#123;release&#125;-root</span><br><span class="line"># OR</span><br><span class="line">%&#123;_tmppath&#125;/%&#123;name&#125;-%&#123;version&#125;-%&#123;release&#125;-buildroot-%(%&#123;__id_u&#125; -n&#125;</span><br></pre></td></tr></table></figure>
<p>下面介绍 spec 脚本主体：</p>
<h2 id="prep-阶段"><a href="#prep-阶段" class="headerlink" title="%prep 阶段"></a>%prep 阶段</h2><p>这个阶段是「预处理」，通常用来执行一些解开源程序包的命令，为下一步的编译安装作准备。</p>
<p><code>%prep</code> 和下面的 <code>%build</code>，<code>%install</code> 段一样，除了可以执行 rpm 所定义的宏命令（以<code>%</code>开头）以外，还可以执行 <code>SHELL</code> 命令，命令可以有很多行，如我们常写的 <code>tar</code> 解包命令。功能上类似于 <code>./configure</code>。</p>
<p><code>%prep</code> 阶段进行实际的打包准备工作，它是使用节前缀 <code>%prep</code> 表示的。主要功能有：</p>
<ul>
<li>将文件 ( <code>SOURCES/</code>) 解压到构建目录 (<code>BUILD/</code>)</li>
<li>应用 <code>Patch</code>（打补丁） (<code>SOURCES/ =&gt; BUILD/</code>)</li>
<li>描述 <code>rm -rf $RPM_BUILD_ROOT</code></li>
<li>描述或编辑本部分用到的命令到 <code>PreReq</code></li>
<li>通过 <code>-b .XXX</code> 描述补丁备份</li>
</ul>
<p>它一般包含 <code>%setup</code> 与 <code>%patch</code> 两个命令。<code>%setup</code> 用于将软件包打开，执行 <code>%patch</code> 可将补丁文件加入解开的源程序中。</p>
<p>示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Copy%prep</span><br><span class="line">%setup -q                                     ← 宏的作用是解压并切换到目录</span><br><span class="line">#%patch0 -p1                                  ← 如果需要打补丁，则依次写</span><br><span class="line">#%patch1 -p1                                  ← 如果需要打补丁，则依次写</span><br></pre></td></tr></table></figure>
<h3 id="setup"><a href="#setup" class="headerlink" title="%setup"></a>%setup</h3><p>这个宏解压源代码，将当前目录改为源代码解压之后产生的目录。这个宏还有一些选项可以用。例如，在解压后，<code>%setup</code> 宏假设产生的目录是 <code>%{name}-%{version}</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copy%setup -n %&#123;name&#125;-%&#123;version&#125; #把源码包解压并放好</span><br></pre></td></tr></table></figure>
<p>主要的用途就是将 <code>%sourcedir</code> 目录下的源代码解压到 <code>%builddir</code> 目录下，也就是将<code>~/rpmbuild/SOURCES</code> 里的包解压到 <code>~/rpmbuild/BUILD/%{name}-%{version}</code> 中。一般用 <code>%setup -c</code> 就可以了，但有两种情况：</p>
<ul>
<li>一就是同时编译多个源码包，</li>
<li>二就是源码的 tar 包的名称与解压出来的目录不一致，此时，就需要使用 <code>-n</code> 参数指定一下。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Copy%setup 不加任何选项，仅将软件包打开。</span><br><span class="line">%setup -a 切换目录前，解压指定 Source 文件，例如 `-a 0` 表示解压 `Source0`</span><br><span class="line">%setup -n newdir 将软件包解压在newdir目录。</span><br><span class="line">%setup -c 解压缩之前先产生目录。</span><br><span class="line">%setup -b num 将第 num 个 source 文件解压缩。</span><br><span class="line">%setup -D 解压前不删除目录</span><br><span class="line">%setup -T 不使用default的解压缩操作。</span><br><span class="line">%setup -T -b 0 将第 0 个源代码文件解压缩。</span><br><span class="line">%setup -c -n newdir 指定目录名称 newdir，并在此目录产生 rpm 套件。</span><br><span class="line">%patch 最简单的补丁方式，自动指定patch level。</span><br><span class="line">%patch 0 使用第0个补丁文件，相当于%patch ?p 0。</span><br><span class="line">%patch -s 不显示打补丁时的信息。</span><br><span class="line">%patch -T 将所有打补丁时产生的输出文件删除</span><br></pre></td></tr></table></figure>
<p>应该 <code>-q</code> 参数给 <code>%setup</code> 宏。这会显著减少编译日志文件的输出，尤其是源代码包会解压出一堆文件的时候。</p>
<p>在 <code>~/rmpbuild/BUILD/%{name}-%{version}</code> 目录中进行 ，使用标准写法，会引用<code>/usr/lib/rpm/marcros</code> 中定义的参数。</p>
<h3 id="patch"><a href="#patch" class="headerlink" title="%patch"></a>%patch</h3><p>这个宏将头部定义的补丁应用于源代码。如果定义了多个补丁，它可以用一个数字的参数来指示应用哪个补丁文件。它也接受 <code>-b extension</code> 参数，指示 RPM 在打补丁之前，将文件备份为扩展名是 <code>extension</code> 的文件。</p>
<p>通常补丁都会一起在源码 <code>tar.gz</code> 包中，或放到 <code>SOURCES</code> 目录下。一般参数为：</p>
<ul>
<li><code>%patch -p1</code> 使用前面定义的 <code>Patch</code> 补丁进行，<code>-p1</code>是忽略 <code>patch</code> 的第一层目录</li>
<li><code>%Patch2 -p1 -b xxx.patch</code>打上指定的补丁，<code>-b</code>是指生成备份文件</li>
</ul>
<h2 id="build-阶段"><a href="#build-阶段" class="headerlink" title="%build 阶段"></a>%build 阶段</h2><p>本段是「构建」阶段，这个阶段会在 <code>%_builddir</code> 目录下执行源码包的编译。一般是执行执行常见的 <code>configure</code> 和 <code>make</code> 操作。</p>
<p>该阶段一般由多个 <code>make</code> 命令组成。与 <code>%prep</code> 段落一样，这些命令可以是 <code>shell</code> 命令，也可以是宏。</p>
<p>记住两点：</p>
<ol>
<li><code>%build</code> 和 <code>%install</code> 的过程中，都必须把编译和安装的文件定义到“虚拟根目录” 中</li>
<li><code>%file</code> 中必须明白，用的是相对目录</li>
</ol>
<p>这个阶段我们最常见只有两条指令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Copy%configure</span><br><span class="line">make %&#123;?_smp_mflags&#125; OPTIMIZE=&quot;%&#123;optflags&#125;&quot;           ← 多核则并行编译</span><br></pre></td></tr></table></figure>
<p><code>%configure</code> 这个不是关键字，而是 rpm 定义的标准宏命令。意思是执行源代码的<code>configure</code>配置。会自动将 <code>prefix</code> 设置成 <code>/usr</code>。</p>
<p>这个 <code>%{?_smp_mflags} %{optflags}</code> 是什么意思呢？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Copy$ rpm --eval &quot;%&#123;?_smp_mflags&#125;&quot;</span><br><span class="line">-j4</span><br><span class="line">$ rpm --eval &quot;%&#123;optflags&#125;&quot;</span><br><span class="line">-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches   -m64 -mtune=generic</span><br></pre></td></tr></table></figure>
<p>所以，上面那个命令就是 <code>make -j4</code>。问题又来了，<code>make -j4</code> 表示什么意思？</p>
<blockquote>
<p>都是一些优化参数</p>
</blockquote>
<ul>
<li><a href="https://nanxiao.me/linux-kernel-note-26-make-j/" target="_blank" rel="noopener">Linux kernel 笔记 （26）——利用“make -j”提高编译<code>kernel</code>速度</a></li>
<li><a href="https://bbs.csdn.net/topics/380072770" target="_blank" rel="noopener">CSDB-make -j4是什么意思</a></li>
</ul>
<h2 id="install-阶段"><a href="#install-阶段" class="headerlink" title="%install 阶段"></a>%install 阶段</h2><p>「安装」阶段，就是执行 <code>make install</code> 命令操作。开始把软件安装到虚拟的根目录中。这个阶段会在 <code>%buildrootdir</code> 目录里建好目录结构，然后将需要打包到 rpm 软件包里的文件从 <code>%builddir</code> 里拷贝到 <code>%_buildrootdir</code> 里对应的目录里。</p>
<p>在 <code>~/rpmbuild/BUILD/%{name}-%{version}</code> 目录中进行 <code>make install</code> 的操作。<code>%install</code> 很重要，因为如果这里的路径不对的话，则下面 <code>%file</code> 中寻找文件的时候就会失败。</p>
<p>特别需要注意的是：<code>%install</code> 部分使用的是绝对路径，而 <code>%file</code> 部分使用则是相对路径，虽然其描述的是同一个地方。千万不要写错。</p>
<p>当用户最终用 <code>rpm -ivh name-version.rpm</code> 安装软件包时，这些文件会安装到用户系统中相应的目录里。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Copy%install</span><br><span class="line">if [-d %&#123;buildroot&#125;]; then</span><br><span class="line">   rm -rf %&#123;buildroot&#125;                      ← 清空下安装目录，实际会自动清除</span><br><span class="line">fi</span><br><span class="line">make install DESTDIR=%&#123;buildroot&#125;           ← 安装到buildroot目录下</span><br><span class="line">%&#123;__install&#125; -Dp -m0755 contrib/init.d %&#123;buildroot&#125;%&#123;_initrddir&#125;/foobar</span><br><span class="line">%&#123;__install&#125; -d %&#123;buildroot&#125;%&#123;_sysconfdir&#125;/foobar.d/</span><br></pre></td></tr></table></figure>
<p>「翻译」一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Copymake install DESTDIR=/root/rpmbuild/BUILDROOT/%&#123;name&#125;-%&#123;version&#125;-%&#123;release&#125;.x86_64</span><br><span class="line">make install DESTDIR=/root/rpmbuild/BUILDROOT/%&#123;name&#125;-%&#123;version&#125;-%&#123;release&#125;.x86_64</span><br><span class="line">/usr/bin/install -d /root/rpmbuild/BUILDROOT/%&#123;name&#125;-%&#123;version&#125;-%&#123;release&#125;.x86_64/etc/foobar.d/</span><br></pre></td></tr></table></figure>
<p>需要说明的是，这里的 <code>%install</code> 主要就是为了后面的 <code>%file</code> 服务的。所以，还可以使用常规的系统命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Copyinstall -d $RPM_BUILD_ROOT/</span><br><span class="line">cp -a * $RPM_BUILD_ROOT/</span><br></pre></td></tr></table></figure>
<p>其中 <code>%{buildroot}</code> 和 <code>$RPMBUILDROOT</code> 是等价的， <code>%{buildroot}</code>必须全部用小写，不然要报错。</p>
<p>注意区分 <code>$RPM_BUILD_ROOT</code>和 <code>$RPM_BUILD_DIR</code>：</p>
<ul>
<li><code>$RPM_BUILD_ROOT</code> 是指开头定义的 <code>BuildRoot</code>，是 <code>%file</code> 需要的。</li>
<li><code>$RPM_BUILD_DIR</code> 通常就是指 <code>~/rpmbuild/BUILD</code></li>
</ul>
<h3 id="scripts-section-没必要可以不填"><a href="#scripts-section-没必要可以不填" class="headerlink" title="scripts section 没必要可以不填"></a>scripts section 没必要可以不填</h3><ul>
<li><code>%pre</code> 安装前执行的脚本</li>
<li><code>%post</code> 安装后执行的脚本</li>
<li><code>%preun</code> 卸载前执行的脚本</li>
<li><code>%postun</code> 卸载后执行的脚本</li>
<li><code>%pretrans</code> 在事务开始时执行脚本</li>
<li><code>%posttrans</code> 在事务结束时执行脚本</li>
</ul>
<p><code>%preun</code> <code>%postun</code> 的区别是什么呢？</p>
<ul>
<li>前者在升级的时候会执行，后者在升级 rpm 包的时候不会执行</li>
</ul>
<h2 id="files-阶段"><a href="#files-阶段" class="headerlink" title="%files 阶段"></a>%files 阶段</h2><p>本段是文件段，主要用来说明会将 <code>%{buildroot}</code> 目录下的哪些文件和目录最终打包到rpm包里。定义软件包所包含的文件，分为三类：</p>
<ul>
<li>说明文档（doc）</li>
<li>配置文件（config）</li>
<li>执行程序</li>
</ul>
<p>还可定义文件存取权限，拥有者及组别。</p>
<p>这里会在虚拟根目录下进行，千万不要写绝对路径，而应用宏或变量表示相对路径。</p>
<p>在 <code>%files</code> 阶段的第一条命令的语法是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copy%defattr(文件权限,用户名,组名,目录权限)</span><br></pre></td></tr></table></figure>
<p>注意点：同时需要在 <code>%install</code> 中安装。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Copy%files</span><br><span class="line">%defattr (-,root,root,0755)                         ← 设定默认权限</span><br><span class="line">%config(noreplace) /etc/my.cnf                      ← 表明是配置文件，noplace表示替换文件</span><br><span class="line">%doc %&#123;src_dir&#125;/Docs/ChangeLog                      ← 表明这个是文档</span><br><span class="line">%attr(644, root, root) %&#123;_mandir&#125;/man8/mysqld.8*    ← 分别是权限，属主，属组</span><br><span class="line">%attr(755, root, root) %&#123;_sbindir&#125;/mysqld</span><br></pre></td></tr></table></figure>
<p><code>%exclude</code> 列出不想打包到 rpm 中的文件。注意：如果 <code>%exclude</code> 指定的文件不存在，也会出错的。</p>
<p>在安装 rpm 时，会将可执行的二进制文件放在 <code>/usr/bin</code> 目录下，动态库放在 <code>/usr/lib</code> 或者 <code>/usr/lib64</code> 目录下，配置文件放在 <code>/etc</code> 目录下，并且多次安装时新的配置文件不会覆盖以前已经存在的同名配置文件。</p>
<p>关于 <code>%files</code> 阶段有两个特性：</p>
<ol>
<li><code>%{buildroot}</code> 里的所有文件都要明确被指定是否要被打包到 rpm里。什么意思呢？假如，<code>%{buildroot}</code> 目录下有 4 个目录 a、b、c和d，在 <code>%files</code> 里仅指定 a 和 b 要打包到 rpm 里，如果不把 c 和 d 用 <code>exclude</code> 声明是要报错的；</li>
<li>如果声明了 <code>%{buildroot}</code> 里不存在的文件或者目录也会报错。</li>
</ol>
<p>关于 <code>%doc</code> 宏，所有跟在这个宏后面的文件都来自 <code>%{_builddir}</code> 目录，当用户安装 rpm 时，由这个宏所指定的文件都会安装到 <code>/usr/share/doc/name-version/</code> 目录里。</p>
<h2 id="clean"><a href="#clean" class="headerlink" title="%clean"></a>%clean</h2><p>清理段，可以通过 <code>--clean</code> 删除 <code>BUILD</code></p>
<p>编译完成后一些清理工作，主要包括对 <code>%{buildroot}</code> 目录的清空(这不是必须的)，通常执行诸如 <code>make clean</code> 之类的命令。</p>
<h2 id="changelog"><a href="#changelog" class="headerlink" title="%changelog"></a>%changelog</h2><p>本段是修改日志段，记录 spec 的修改日志段。你可以将软件的每次修改记录到这里，保存到发布的软件包中，以便查询之用。</p>
<p>每一个修改日志都有这样一种格式：</p>
<ul>
<li>第一行是：<code>* 星期 月 日 年 修改人 电子信箱</code>。其中：星期、月份均用英文形式的前 3 个字母，用中文会报错。</li>
<li>接下来的行写的是修改了什么地方，可写多行。一般以减号开始，便于后续的查阅。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Copy%changelog</span><br><span class="line">* Fri Dec 29 2012 foobar &lt;foobar@kidding.com&gt; - 1.0.0-1</span><br><span class="line">- Initial version</span><br></pre></td></tr></table></figure>
<h2 id="宏"><a href="#宏" class="headerlink" title="宏"></a>宏</h2><p>在定义文件的安装路径时，通常会使用类似 <code>%_sharedstatedir</code> 的宏，这些宏一般会在 <code>/usr/lib/rpm/macros</code> 中定义。关于宏的语法，可以查看 <a href="https://rpm.org/user_doc/macros.html" target="_blank" rel="noopener">Macro syntax</a></p>
<p>RPM 内建宏定义在 <code>/usr/lib/rpm/redhat/macros</code> 文件中，这些宏基本上定义了目录路径或体系结构等等；同时也包含了一组用于调试 spec 文件的宏。</p>
<p>所有宏都可以在 <code>/usr/lib/rpm/macros</code> 找到，附录一些常见的宏：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">Copy%&#123;_sysconfdir&#125;        /etc</span><br><span class="line">%&#123;_prefix&#125;            /usr</span><br><span class="line">%&#123;_exec_prefix&#125;       %&#123;_prefix&#125;</span><br><span class="line">%&#123;_bindir&#125;            %&#123;_exec_prefix&#125;/bin</span><br><span class="line">%&#123;_lib&#125;               lib (lib64 on 64bit systems)</span><br><span class="line">%&#123;_libdir&#125;            %&#123;_exec_prefix&#125;/%&#123;_lib&#125;</span><br><span class="line">%&#123;_libexecdir&#125;        %&#123;_exec_prefix&#125;/libexec</span><br><span class="line">%&#123;_sbindir&#125;           %&#123;_exec_prefix&#125;/sbin</span><br><span class="line">%&#123;_sharedstatedir&#125;    /var/lib</span><br><span class="line">%&#123;_datadir&#125;           %&#123;_prefix&#125;/share</span><br><span class="line">%&#123;_includedir&#125;        %&#123;_prefix&#125;/include</span><br><span class="line">%&#123;_oldincludedir&#125;     /usr/include</span><br><span class="line">%&#123;_infodir&#125;           /usr/share/info</span><br><span class="line">%&#123;_mandir&#125;            /usr/share/man</span><br><span class="line">%&#123;_localstatedir&#125;     /var</span><br><span class="line">%&#123;_initddir&#125;          %&#123;_sysconfdir&#125;/rc.d/init.d </span><br><span class="line">%&#123;_topdir&#125;            %&#123;getenv:HOME&#125;/rpmbuild</span><br><span class="line">%&#123;_builddir&#125;          %&#123;_topdir&#125;/BUILD</span><br><span class="line">%&#123;_rpmdir&#125;            %&#123;_topdir&#125;/RPMS</span><br><span class="line">%&#123;_sourcedir&#125;         %&#123;_topdir&#125;/SOURCES</span><br><span class="line">%&#123;_specdir&#125;           %&#123;_topdir&#125;/SPECS</span><br><span class="line">%&#123;_srcrpmdir&#125;         %&#123;_topdir&#125;/SRPMS</span><br><span class="line">%&#123;_buildrootdir&#125;      %&#123;_topdir&#125;/BUILDROOT</span><br><span class="line">%&#123;_var&#125;               /var</span><br><span class="line">%&#123;_tmppath&#125;           %&#123;_var&#125;/tmp</span><br><span class="line">%&#123;_usr&#125;               /usr</span><br><span class="line">%&#123;_usrsrc&#125;            %&#123;_usr&#125;/src</span><br><span class="line">%&#123;_docdir&#125;            %&#123;_datadir&#125;/doc</span><br><span class="line">%&#123;buildroot&#125;          %&#123;_buildrootdir&#125;/%&#123;name&#125;-%&#123;version&#125;-%&#123;release&#125;.%&#123;_arch&#125;</span><br><span class="line">$RPM_BUILD_ROOT       %&#123;buildroot&#125;</span><br></pre></td></tr></table></figure>
<p>利用 rpmbuild 构建 rpm 安装包时，通过命令 <code>rpm --showrc|grep prefix</code> 查看。</p>
<p>通过 <code>rpm --eval &quot;%{macro}&quot;</code> 来查看具体对应路径。</p>
<p>比如我们要查看 <code>%{_bindir}</code> 的路径，就可以使用命令 <code>rpm --eval &quot;%{ _bindir}&quot;</code> 来查看。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Copy%&#123;_topdir&#125;            %&#123;getenv:HOME&#125;/rpmbuild</span><br><span class="line">%&#123;_builddir&#125;          %&#123;_topdir&#125;/BUILD</span><br><span class="line">%&#123;_rpmdir&#125;            %&#123;_topdir&#125;/RPMS</span><br><span class="line">%&#123;_sourcedir&#125;         %&#123;_topdir&#125;/SOURCES</span><br><span class="line">%&#123;_specdir&#125;           %&#123;_topdir&#125;/SPECS</span><br><span class="line">%&#123;_srcrpmdir&#125;         %&#123;_topdir&#125;/SRPMS</span><br><span class="line">%&#123;_buildrootdir&#125;      %&#123;_topdir&#125;/BUILDROOT</span><br><span class="line"></span><br><span class="line">Note: On releases older than Fedora 10 (and EPEL), %&#123;_buildrootdir&#125; does not exist.</span><br><span class="line">Build flags macros</span><br><span class="line"></span><br><span class="line">%&#123;_global_cflags&#125;     -O2 -g -pipe</span><br><span class="line">%&#123;_optflags&#125;          %&#123;__global_cflags&#125; -m32 -march=i386 -mtune=pentium4 # if redhat-rpm-config is installed</span><br></pre></td></tr></table></figure>
<h2 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h2><p><code>define</code> 定义的变量类似于局部变量，只在 <code>%{!?foo: ... }</code> 区间有效，不过 SPEC 并不会自动清除该变量，只有再次遇到 <code>%{}</code> 时才会清除</p>
<h3 id="define-vs-global"><a href="#define-vs-global" class="headerlink" title="define vs. global"></a>define vs. global</h3><p>两者都可以用来进行变量定义，不过在细节上有些许差别，简单列举如下：</p>
<ul>
<li><code>define</code> 用来定义宏，<code>global</code> 用来定义变量；</li>
<li>如果定义带参数的宏 (类似于函数)，必须要使用 <code>define</code>；</li>
<li>在 <code>%{}</code> 内部，必须要使用 <code>global</code> 而非 <code>define</code>；</li>
<li><code>define</code> 在使用时计算其值，而 <code>global</code> 则在定义时就计算其值；</li>
</ul>
<p>可以简单参考如下的示例。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Copy#--- %prep之前的参数是必须要有的</span><br><span class="line">Name:           mysql</span><br><span class="line">Version:        5.7.17</span><br><span class="line">Release:        1%&#123;?dist&#125;</span><br><span class="line">Summary:        MySQL from FooBar.</span><br><span class="line">License:        GPLv2+ and BSD</span><br><span class="line"></span><br><span class="line">%description</span><br><span class="line">It is a MySQL from FooBar.</span><br><span class="line"></span><br><span class="line">%prep</span><br><span class="line">#--- 带参数时，必须使用%define定义</span><br><span class="line">%define myecho() echo %1 %2</span><br><span class="line">%&#123;!?bar: %define bar defined&#125;</span><br><span class="line"></span><br><span class="line">echo 1: %&#123;bar&#125;</span><br><span class="line">%&#123;myecho 2: %&#123;bar&#125;&#125;</span><br><span class="line">echo 3: %&#123;bar&#125;</span><br><span class="line"></span><br><span class="line"># 如下是输出内容</span><br><span class="line">#1: defined</span><br><span class="line">#2: defined</span><br><span class="line">#3: %&#123;bar&#125;</span><br></pre></td></tr></table></figure>
<p>3 的输出是不符合预期的，可以将 <code>%define</code> 修改为 <code>global</code> 即可</p>
<h3 id="dist-表示什么含义"><a href="#dist-表示什么含义" class="headerlink" title="%{?dist} 表示什么含义"></a>%{?dist} 表示什么含义</h3><p>不加问号，如果 <code>dist</code> 有定义，那么就会用定义的值替换，否则就会保 <code>%{dist}</code>;<br> 加问好，如果 <code>dist</code> 有定义，那么也是会用定义的值替换，否则就直接移除这个tag <code>%{?dist}</code></p>
<p>举例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Copy$ rpm -E &apos;foo:%&#123;foo&#125;&apos;$&apos;\n&apos;&apos;bar:%&#123;?bar&#125;&apos;</span><br><span class="line">foo:%&#123;foo&#125;</span><br><span class="line">bar:</span><br><span class="line"></span><br><span class="line">$ rpm -D&apos;foo foov&apos; -E &apos;foo:%&#123;foo&#125;&apos;$&apos;\n&apos;&apos;bar:%&#123;?bar&#125;&apos;</span><br><span class="line">foo:foov</span><br><span class="line">bar:</span><br><span class="line"></span><br><span class="line">$ rpm -D&apos;foo foov&apos; -D&apos;bar barv&apos; -E &apos;foo:%&#123;foo&#125;&apos;$&apos;\n&apos;&apos;bar:%&#123;?bar&#125;&apos;</span><br><span class="line">foo:foov</span><br><span class="line">bar:barv</span><br></pre></td></tr></table></figure>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>看了以上SPEC的总结，以为了解差不多了，结果看了网络域的SPEC文件，自己真实<code>too young too simple</code>。看看能否看懂吧：<a href="http://code.huawei.com/cloudos-packages/fn-venv-python-common-packages-arm/blob/master/fn-venv-python-common-packages.spec" target="_blank" rel="noopener">fn-venv-python-common-packages-arm</a></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://my.oschina.net/u/913265/blog/892889" target="_blank" rel="noopener">开源中国-RPM包的制作</a> 对 rpmbuild 目录的创建及生成介绍比较详细</li>
<li><a href="http://hlee.iteye.com/blog/343499" target="_blank" rel="noopener">夜鸣猪-RPM包rpmbuild SPEC文件深度说明</a></li>
<li><a href="https://zh.opensuse.org/index.php?title=openSUSE:Specfile_guidelines&amp;variant=zh-hans" target="_blank" rel="noopener">OpenSUSE-spec 文件指南</a></li>
<li><a href="https://blog.csdn.net/get_set/article/details/53453320" target="_blank" rel="noopener">CSDN-RPM打包原理、示例、详解及备查</a> 很详细，有示例</li>
<li><a href="https://fedoraproject.org/wiki/How_to_create_an_RPM_package/zh-cn#.E6.96.B0.E5.BB.BA.E4.B8.80.E4.B8.AA_.spec_.E6.96.87.E4.BB.B6" target="_blank" rel="noopener">Fedora-WIKI-How to create an RPM package/zh-cn</a> 中文介绍</li>
<li><a href="https://www.ibm.com/developerworks/cn/linux/l-rpm/index.htm" target="_blank" rel="noopener">IBM-RPM 打包技术与典型 SPEC 文件分析</a></li>
<li><a href="https://jin-yang.github.io/post/linux-create-rpm-package.html" target="_blank" rel="noopener">JIN-YANG-RPM 包制作</a> 总结很全，还介绍了签名</li>
<li><a href="https://blog.csdn.net/younger_china/article/details/53131105" target="_blank" rel="noopener">CSDN-RPM构建 - SPEC文件参数解析</a> 该博主，总共围绕 RPM 构建写了几篇文章的</li>
<li><a href="http://www.linuxfly.org/post/137/" target="_blank" rel="noopener">原-关于rpm打包中的条件判断</a> 介绍了 spec 中条件判断的语法</li>
<li><a href="https://stackoverflow.com/questions/25508687/whats-the-meaing-of-1dist-in-spec-file-in-rpm-package" target="_blank" rel="noopener">Whats the meaing of 1%{?dist} in SPEC file in RPM package</a></li>
</ul>
<p>作者：<a href="https://michael728.github.io/" target="_blank" rel="noopener">             MichaelXoX         </a></p>
<p>出处：<a href="https://www.cnblogs.com/michael-xiang/p/10480809.html" target="_blank" rel="noopener">https://www.cnblogs.com/michael-xiang/p/10480809.html</a></p>
<p>本站使用「<a href="https://creativecommons.org/licenses/by/4.0" target="_blank" rel="noopener">署名 4.0 国际</a>」创作共享协议，转载请在文章明显位置注明作者及出处。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhanghongtong.github.io/2019/08/29/用wget下载整个网站，或者特定目录全部文件/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张奇怪">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张奇怪的blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/29/用wget下载整个网站，或者特定目录全部文件/" itemprop="url">用wget下载整个网站，或者特定目录全部文件</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-08-29T17:33:54+08:00">
                2019-08-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/服务器/" itemprop="url" rel="index">
                    <span itemprop="name">服务器</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>需要下载某个目录下面的所有文件。<br>命令如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -c -r -np -k -L -p http://docs.openstack.org/liberty/install-guide-rdo/</span><br></pre></td></tr></table></figure></p>
<p>在下载时。有用到外部域名的图片或连接。如果需要同时下载就要用-H参数。<br>wget -np -nH -r –span-hosts <a href="http://www.xianren.org/pub/path/" target="_blank" rel="noopener">www.xianren.org/pub/path/</a></p>
<p>参数：</p>
<ul>
<li>-c 断点续传</li>
<li>-r 递归下载，下载指定网页某一目录下（包括子目录）的所有文件</li>
<li>-nd 递归下载时不创建一层一层的目录，把所有的文件下载到当前目录</li>
<li>-np 递归下载时不搜索上层目录，如wget -c -r <a href="http://www.xianren.org/pub/path/" target="_blank" rel="noopener">www.xianren.org/pub/path/</a></li>
<li>没有加参数-np，就会同时下载path的上一级目录pub下的其它文件</li>
<li>-k 将绝对链接转为相对链接，下载整个站点后脱机浏览网页，最好加上这个参数</li>
<li>-L 递归时不进入其它主机，如wget -c -r <a href="http://www.xianren.org/" target="_blank" rel="noopener">www.xianren.org/</a></li>
<li>如果网站内有一个这样的链接：</li>
<li><a href="http://www.xianren.org，不加参数-L，就会像大火烧山一样，会递归下载www.xianren.org网站" target="_blank" rel="noopener">www.xianren.org，不加参数-L，就会像大火烧山一样，会递归下载www.xianren.org网站</a></li>
<li>-p 下载网页所需的所有文件，如图片等</li>
<li>-A 指定要下载的文件样式列表，多个样式用逗号分隔</li>
<li>-i 后面跟一个文件，文件内指明要下载的URL</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhanghongtong.github.io/2019/07/20/构建多种系统架构支持的-Docker-镜像-docker-manifest-命令详解/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张奇怪">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张奇怪的blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/20/构建多种系统架构支持的-Docker-镜像-docker-manifest-命令详解/" itemprop="url">构建多种系统架构支持的 Docker 镜像 -- docker manifest 命令详解</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-07-20T20:05:49+08:00">
                2019-07-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/docker/" itemprop="url" rel="index">
                    <span itemprop="name">docker</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>我们知道使用镜像创建一个容器，该镜像必须与 Docker 宿主机系统架构一致，例如 <code>Linux x86_64</code> 架构的系统中只能使用 <code>Linux x86_64</code> 的镜像创建容器。</p>
<blockquote>
<p>macOS 除外，其使用了 <a href="https://docs.docker.com/docker-for-mac/multi-arch/" target="_blank" rel="noopener">binfmt_misc</a> 提供了多种架构支持，在 macOS 系统上 (x86_64) 可以运行 arm 等其他架构的镜像。</p>
</blockquote>
<p>例如我们在 Linux x86_64 中构建一个 username/test 镜像。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FROM alpine</span><br><span class="line"></span><br><span class="line">CMD echo 1</span><br></pre></td></tr></table></figure>
<p>构建镜像后推送到 Docker Hub，之后我们尝试在树莓派 <code>Linux arm64v8</code> 中使用这个镜像。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -it --rm username/test</span><br></pre></td></tr></table></figure>
<p>可以发现这个镜像根本获取不到。</p>
<p>要解决这个问题，通常采用的做法是通过镜像名区分不同系统架构的镜像，例如在 <code>Linux x86_64</code> 和 <code>Linux arm64v8</code> 分别构建 <code>username/test</code> 和 <code>username/arm64v8-test</code> 镜像。运行时使用对应架构的镜像即可。</p>
<p>这样做显得很繁琐，那么有没有一种方法让 Docker 引擎根据系统架构自动拉取对应的镜像呢？</p>
<p>我们发现在<code>Linux x86_64</code> 和 <code>Linux arm64v8</code> 架构的计算机中执行 <code>$ docker run golang:alpine go version</code> 时我们发现可以正确的运行。</p>
<p>这是什么原因呢？</p>
<p>原因就是 <code>golang:alpine</code> 官方镜像有一个 <a href="https://docs.docker.com/registry/spec/manifest-v2-2/" target="_blank" rel="noopener">manifest 列表</a>。</p>
<p>当用户获取一个镜像时，Docker 引擎会首先查找该镜像是否有 manifest 列表，如果有的话 Docker 引擎会按照 Docker 运行环境（系统及架构）查找出对应镜像（例如 <code>golang:alpine</code>）。如果没有的话会直接获取镜像（例如上例中我们构建的 <code>username/test</code>）。</p>
<p>我们可以使用 <code>$ docker manifest inspect golang:alpine</code> 查看这个 <code>manifest</code> 列表的结构。</p>
<p>由于该命令属于实验特性，必须设置如下 <strong>环境变量</strong> 之后才能使用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Linux、macOS</span><br><span class="line">$ export DOCKER_CLI_EXPERIMENTAL=enabled</span><br><span class="line"></span><br><span class="line"># Windows</span><br><span class="line">$ set $env:DOCKER_CLI_EXPERIMENTAL=enabled</span><br></pre></td></tr></table></figure>
<blockquote>
<p>以上是设置环境变量的临时方法，若使环境变量永久生效请读者自行设置。</p>
</blockquote>
<p>设置之后，执行结果如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker manifest inspect golang:alpine</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   &quot;schemaVersion&quot;: 2,</span><br><span class="line">   &quot;mediaType&quot;: &quot;application/vnd.docker.distribution.manifest.list.v2+json&quot;,</span><br><span class="line">   &quot;manifests&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">         &quot;mediaType&quot;: &quot;application/vnd.docker.distribution.manifest.v2+json&quot;,</span><br><span class="line">         &quot;size&quot;: 1365,</span><br><span class="line">         &quot;digest&quot;: &quot;sha256:5e28ac423243b187f464d635bcfe1e909f4a31c6c8bce51d0db0a1062bec9e16&quot;,</span><br><span class="line">         &quot;platform&quot;: &#123;</span><br><span class="line">            &quot;architecture&quot;: &quot;amd64&quot;,</span><br><span class="line">            &quot;os&quot;: &quot;linux&quot;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">         &quot;mediaType&quot;: &quot;application/vnd.docker.distribution.manifest.v2+json&quot;,</span><br><span class="line">         &quot;size&quot;: 1365,</span><br><span class="line">         &quot;digest&quot;: &quot;sha256:2945c46e26c9787da884b4065d1de64cf93a3b81ead1b949843dda1fcd458bae&quot;,</span><br><span class="line">         &quot;platform&quot;: &#123;</span><br><span class="line">            &quot;architecture&quot;: &quot;arm&quot;,</span><br><span class="line">            &quot;os&quot;: &quot;linux&quot;,</span><br><span class="line">            &quot;variant&quot;: &quot;v7&quot;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">         &quot;mediaType&quot;: &quot;application/vnd.docker.distribution.manifest.v2+json&quot;,</span><br><span class="line">         &quot;size&quot;: 1365,</span><br><span class="line">         &quot;digest&quot;: &quot;sha256:87fff60114fd3402d0c1a7ddf1eea1ded658f171749b57dc782fd33ee2d47b2d&quot;,</span><br><span class="line">         &quot;platform&quot;: &#123;</span><br><span class="line">            &quot;architecture&quot;: &quot;arm64&quot;,</span><br><span class="line">            &quot;os&quot;: &quot;linux&quot;,</span><br><span class="line">            &quot;variant&quot;: &quot;v8&quot;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">         &quot;mediaType&quot;: &quot;application/vnd.docker.distribution.manifest.v2+json&quot;,</span><br><span class="line">         &quot;size&quot;: 1365,</span><br><span class="line">         &quot;digest&quot;: &quot;sha256:607b43f1d91144f82a9433764e85eb3ccf83f73569552a49bc9788c31b4338de&quot;,</span><br><span class="line">         &quot;platform&quot;: &#123;</span><br><span class="line">            &quot;architecture&quot;: &quot;386&quot;,</span><br><span class="line">            &quot;os&quot;: &quot;linux&quot;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">         &quot;mediaType&quot;: &quot;application/vnd.docker.distribution.manifest.v2+json&quot;,</span><br><span class="line">         &quot;size&quot;: 1365,</span><br><span class="line">         &quot;digest&quot;: &quot;sha256:25ead0e21ed5e246ce31e274b98c09aaf548606788ef28eaf375dc8525064314&quot;,</span><br><span class="line">         &quot;platform&quot;: &#123;</span><br><span class="line">            &quot;architecture&quot;: &quot;ppc64le&quot;,</span><br><span class="line">            &quot;os&quot;: &quot;linux&quot;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">         &quot;mediaType&quot;: &quot;application/vnd.docker.distribution.manifest.v2+json&quot;,</span><br><span class="line">         &quot;size&quot;: 1365,</span><br><span class="line">         &quot;digest&quot;: &quot;sha256:69f5907fa93ea591175b2c688673775378ed861eeb687776669a48692bb9754d&quot;,</span><br><span class="line">         &quot;platform&quot;: &#123;</span><br><span class="line">            &quot;architecture&quot;: &quot;s390x&quot;,</span><br><span class="line">            &quot;os&quot;: &quot;linux&quot;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出 <code>manifest</code> 列表中包含了不同系统架构所对应的镜像 <code>digest</code> 值，这样 Docker 就可以在不同的架构中使用相同的 <code>manifest</code> (例如 <code>golang:alpine</code>) 获取对应的镜像。</p>
<p>下面介绍如何使用 <code>$ docker manifest</code> 命令创建并推送 <code>manifest</code> 列表到 Docker Hub。</p>
<h3 id="构建镜像"><a href="#构建镜像" class="headerlink" title="构建镜像"></a>构建镜像</h3><p>首先在 <code>Linux x86_64</code> 构建 <code>username/x8664-test</code> 镜像。并在 <code>Linux arm64v8</code> 中构建 <code>username/arm64v8-test</code> 镜像，构建好之后推送到 Docker Hub。</p>
<h3 id="创建-manifest-列表"><a href="#创建-manifest-列表" class="headerlink" title="创建 manifest 列表"></a>创建 <code>manifest</code> 列表</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># $ docker manifest create MANIFEST_LIST MANIFEST [MANIFEST...]</span><br><span class="line">$ docker manifest create username/test \</span><br><span class="line">      username/x8664-test \</span><br><span class="line">      username/arm64v8-test</span><br></pre></td></tr></table></figure>
<p>当要修改一个 <code>manifest</code> 列表时，可以加入 <code>-a,--amend</code> 参数。</p>
<h3 id="设置-manifest-列表"><a href="#设置-manifest-列表" class="headerlink" title="设置 manifest 列表"></a>设置 <code>manifest</code> 列表</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># $ docker manifest annotate [OPTIONS] MANIFEST_LIST MANIFEST</span><br><span class="line">$ docker manifest annotate username/test \</span><br><span class="line">      username/x8664-test \</span><br><span class="line">      --os linux --arch x86_64</span><br><span class="line"></span><br><span class="line">$ docker manifest annotate username/test \</span><br><span class="line">      username/arm64v8-test \</span><br><span class="line">      --os linux --arch arm64 --variant v8</span><br></pre></td></tr></table></figure>
<p>这样就配置好了 <code>manifest</code> 列表。</p>
<h3 id="查看-manifest-列表"><a href="#查看-manifest-列表" class="headerlink" title="查看 manifest 列表"></a>查看 <code>manifest</code> 列表</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker manifest inspect username/test</span><br></pre></td></tr></table></figure>
<h3 id="推送-manifest-列表"><a href="#推送-manifest-列表" class="headerlink" title="推送 manifest 列表"></a>推送 <code>manifest</code> 列表</h3><p>最后我们可以将其推送到 Docker Hub。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker manifest push username/test</span><br></pre></td></tr></table></figure>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>我们在 <code>Linux x86_64</code>、<code>Linux arm64v8</code> 中分别执行 <code>$ docker run -it --rm username/test</code> 命令，发现可以正确的执行。</p>
<p>官方博客</p>
<p>详细了解 manifest 可以阅读官方博客。</p>
<ul>
<li><a href="https://blog.docker.com/2017/11/multi-arch-all-the-things/" target="_blank" rel="noopener">https://blog.docker.com/2017/11/multi-arch-all-the-things/</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhanghongtong.github.io/2019/07/20/Ubuntu下docker使用非root权限运行docker/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张奇怪">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张奇怪的blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/20/Ubuntu下docker使用非root权限运行docker/" itemprop="url">Ubuntu下docker使用非root权限运行docker</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-07-20T19:57:23+08:00">
                2019-07-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/docker/" itemprop="url" rel="index">
                    <span itemprop="name">docker</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>默认情况下，docker 命令会使用 Unix socket 与 Docker 引擎通讯。而只有 root 用户和 docker 组的用户才可以访问 Docker 引擎的 Unix socket。出于安全考虑，一般 Linux 系统上不会直接使用 root 用户。因此，更好地做法是将需要使用 docker 的用户加入 docker 用户组。</p>
<ol>
<li><p>添加 docker group ：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo groupadd docker</span><br></pre></td></tr></table></figure>
</li>
<li><p>将用户加入该 group 内</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo usermod -aG docker $USER</span><br><span class="line"># 或者使用下面命令</span><br><span class="line">$ sudo gpasswd -a $&#123;USER&#125; docker</span><br></pre></td></tr></table></figure>
</li>
<li><p>赋予 <code>~/.docker</code> 目录权限</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo chown &quot;$USER&quot;:&quot;$USER&quot; /home/&quot;$USER&quot;/.docker -R</span><br><span class="line">$ sudo chmod g+rwx &quot;/home/$USER/.docker&quot; -R</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo service docker restart</span><br><span class="line"># 或者</span><br><span class="line">$ sudo /etc/init.d/docker restart</span><br></pre></td></tr></table></figure>
</li>
<li><p>切换当前会话到新 group 或者重启 shell 会话 </p>
<p><strong>这一步是必须的，否则因为 groups 命令获取到的是缓存的组信息，刚添加的组信息未能生效，所以 docker images 执行时同样有错。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ newgrp - docker</span><br></pre></td></tr></table></figure></li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhanghongtong.github.io/2019/06/29/Ubuntu系统上NFS的安装与使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张奇怪">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张奇怪的blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/29/Ubuntu系统上NFS的安装与使用/" itemprop="url">Ubuntu系统上NFS的安装与使用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-06-29T14:48:33+08:00">
                2019-06-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/服务器/" itemprop="url" rel="index">
                    <span itemprop="name">服务器</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="服务器端"><a href="#服务器端" class="headerlink" title="服务器端"></a>服务器端</h2><ol>
<li><p>安装NFS服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#执行以下命令安装NFS服务器，</span><br><span class="line"></span><br><span class="line">#apt会自动安装nfs-common、rpcbind等13个软件包</span><br><span class="line"></span><br><span class="line">sudo apt install nfs-kernel-server</span><br></pre></td></tr></table></figure>
</li>
<li><p>编写配置文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#编辑/etc/exports 文件：</span><br><span class="line">sudo vim /etc/exports</span><br><span class="line"></span><br><span class="line">#/etc/exports文件的内容如下：</span><br><span class="line">/tmp *(rw,sync,no_subtree_check,no_root_squash)</span><br><span class="line">/data *(rw,sync,no_subtree_check,no_root_squash)</span><br><span class="line">/logs *(rw,sync,no_subtree_check,no_root_squash)</span><br></pre></td></tr></table></figure>
<p>各段表达的意思如下，根据实际进行修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/tmp   ：共享的目录</span><br><span class="line"></span><br><span class="line">*       ：指定哪些用户可以访问</span><br><span class="line">            *  所有可以ping同该主机的用户</span><br><span class="line">            192.168.1.*  指定网段，在该网段中的用户可以挂载</span><br><span class="line">            192.168.1.12 只有该用户能挂载</span><br><span class="line"></span><br><span class="line">(ro,sync,no_root_squash)：  权限</span><br><span class="line">        ro : 只读</span><br><span class="line">        rw : 读写</span><br><span class="line">        sync :  同步</span><br><span class="line">        no_root_squash: 不降低root用户的权限</span><br><span class="line">    其他选项man 5 exports 查看</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建共享目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#在服务器端创建/tmp /data和/logs共享目录</span><br><span class="line">sudo mkdir -p /tmp</span><br><span class="line">sudo mkdir -p /data</span><br><span class="line">sudo mkdir -p /logs</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启nfs服务：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service nfs-kernel-server restart</span><br></pre></td></tr></table></figure>
</li>
<li><p>常用命令</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#在安装NFS服务器时，已包含常用的命令行工具，无需额外安装。</span><br><span class="line"></span><br><span class="line">#显示已经mount到本机nfs目录的客户端机器。</span><br><span class="line">sudo showmount -e localhost</span><br><span class="line"></span><br><span class="line">#将配置文件中的目录全部重新export一次！无需重启服务。</span><br><span class="line">sudo exportfs -rv</span><br><span class="line"></span><br><span class="line">#查看NFS的运行状态</span><br><span class="line">sudo nfsstat</span><br><span class="line"></span><br><span class="line">#查看rpc执行信息，可以用于检测rpc运行情况</span><br><span class="line">sudo rpcinfo</span><br><span class="line"></span><br><span class="line">#查看网络端口，NFS默认是使用111端口。</span><br><span class="line">sudo netstat -tu -4</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h2><ol>
<li><p>安装客户端工具</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#在需要连接到NFS服务器的客户端机器上执行以下命令，安装nfs-common软件包。</span><br><span class="line">#apt会自动安装nfs-common、rpcbind等12个软件包</span><br><span class="line">sudo apt install nfs-common</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看NFS服务器上的共享目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#显示指定的（192.168.3.167）NFS服务器上export出来的目录</span><br><span class="line">sudo showmount -e 192.168.3.167</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建本地挂载目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -p /mnt/data</span><br><span class="line">sudo mkdir -p /mnt/logs</span><br></pre></td></tr></table></figure>
</li>
<li><p>挂载共享目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#将NFS服务器192.168.3.167上的目录，挂载到本地的/mnt/目录下</span><br><span class="line">sudo mount -t nfs 192.168.3.167:/data /mnt/data</span><br><span class="line">sudo mount -t nfs 192.168.3.167:/logs /mnt/logs</span><br></pre></td></tr></table></figure>
<p>访问本地的mnt目录，就可访问服务端共享的目录了。</p>
</li>
</ol>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul>
<li><a href="http://server.51cto.com/sManage-150923.htm" target="_blank" rel="noopener">超全面的NFS详解</a></li>
<li><a href="http://www.cnblogs.com/MoreExcellent/p/7222895.html" target="_blank" rel="noopener">ubuntu 16.04 nfs服务的搭建</a></li>
<li><a href="https://blog.csdn.net/CSDN_duomaomao/article/details/77822883" target="_blank" rel="noopener">Ubuntu 16.04系统上NFS的安装与使用</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhanghongtong.github.io/2019/06/27/Ubuntu和docker使用shadowsocks客户端翻墙/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张奇怪">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张奇怪的blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/27/Ubuntu和docker使用shadowsocks客户端翻墙/" itemprop="url">Ubuntu和docker使用shadowsocks客户端代理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-06-27T15:37:30+08:00">
                2019-06-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/docker/" itemprop="url" rel="index">
                    <span itemprop="name">docker</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Ubuntu安装shadowsocks客户端"><a href="#Ubuntu安装shadowsocks客户端" class="headerlink" title="Ubuntu安装shadowsocks客户端"></a>Ubuntu安装shadowsocks客户端</h2><ol>
<li><p>首先安装shadowsocks-libev和privoxy</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># apt-get update</span><br><span class="line"># apt-get install shadowsocks-libev privoxy</span><br></pre></td></tr></table></figure>
</li>
<li><p>编辑shadowsocks配置文件</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># cat /etc/shadowsocks-libev/config</span><br><span class="line">&#123;</span><br><span class="line">    &quot;server&quot;:&quot;1.2.3.4&quot;,</span><br><span class="line">    &quot;server_port&quot;:23333,</span><br><span class="line">    &quot;local_address&quot;:&quot;0.0.0.0&quot;,</span><br><span class="line">    &quot;local_port&quot;:1080,</span><br><span class="line">    &quot;password&quot;:&quot;mypassword&quot;,</span><br><span class="line">    &quot;timeout&quot;:60,</span><br><span class="line">    &quot;method&quot;:&quot;chacha20-ietf-poly1305&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol start="3">
<li><p><code>ss-local</code>启动shadowsocks客户端</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># ss-local</span><br><span class="line"> 2019-02-15 10:08:43 INFO: initializing ciphers... chacha20-ietf-poly1305</span><br><span class="line"> 2019-02-15 10:08:43 INFO: listening at 127.0.0.1:1080</span><br><span class="line"> 2019-02-15 10:08:43 INFO: running from root user</span><br></pre></td></tr></table></figure>
<p> 确认客户端启动没有问题后用<code>nohup ss-local &amp;</code>命令让客户端在后台运行</p>
</li>
<li><p>编辑privoxy配置文件 <code>/etc/privoxy/config</code></p>
<ul>
<li>找到<code>listen-address</code>这一行，将其修改为<code>listen-address localhost:8118， 8118</code>也就是你需要的http代理的端口。</li>
<li>再找到<code>forward-socks5t</code>这一行，取消注释，将这一行修改为<code>forward-socks5 / 127.0.0.1:1080 .</code>，1080是socks代理的端口。</li>
<li>重启服务</li>
<li><code>service privoxy start</code> #默认自启动</li>
</ul>
</li>
<li><p>给系统设置http代理</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># echo &apos;export http_proxy=&quot;http://0.0.0.0:8118/&quot; &gt;&gt; ~/.bashrc&apos;</span><br><span class="line"># source ~/.bashrc</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="docker使用socks5代理加速下载镜像"><a href="#docker使用socks5代理加速下载镜像" class="headerlink" title="docker使用socks5代理加速下载镜像"></a>docker使用socks5代理加速下载镜像</h2><ol>
<li><p>编辑service文件<br><code>vim /usr/lib/systemd/system/docker.service</code><br>不同系统的docker.service文件位置可能不一样，可以使用 <code>find / -name &quot;docker.service&quot;</code> 查找</p>
<p>在<code>[Service]</code>下增加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Environment=HTTP_PROXY=http://127.0.0.1:8118/</span><br><span class="line">Environment=HTTPS_PROXY=http://127.0.0.1:8118/</span><br><span class="line">Environment=NO_PROXY=localhost,127.0.0.1,m1empwb1.mirror.aliyuncs.com,docker.io,registry.cn-hangzhou.aliyuncs.com</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启docker服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># systemctl daemon-reload</span><br><span class="line"># systemctl show docker |grep 127.0.0.1</span><br><span class="line">Environment=HTTP_PROXY=http://127.0.0.1:8118/ HTTPS_PROXY=http://127.0.0.1:8118/ NO_PROXY=localhost,127.0.0.1,m1empwb1.mirror.aliyuncs.com,docker.io,registry.cn-hangzhou.aliyuncs.com ALL_PROXY=socks5://127.0.0.1:1080</span><br><span class="line"># systemctl restart docker</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># docker pull gcr.io/kubernetes-helm/tiller:v2.2.2</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="docker容器使用socks5代理"><a href="#docker容器使用socks5代理" class="headerlink" title="docker容器使用socks5代理"></a>docker容器使用socks5代理</h2><ol>
<li><p>在容器内添加环境变量（IP为宿主机代理IP）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export ALL_PROXY=socks5://10.190.0.61:1080</span><br><span class="line">export http_proxy=&quot;http://10.190.0.61:8118&quot;</span><br><span class="line">export https_proxy=&quot;https://10.190.0.61:8118&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget google.com</span><br><span class="line">Connecting to 10.190.0.61:8118 (10.190.0.61:8118)</span><br><span class="line">index.html           100% |***********************************************************************************************************************************************************| 11323   0:00:00 ETA</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>以上</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhanghongtong.github.io/2019/06/04/docker中执行sed-can-t-move-etc-resolv-conf73UqmG-to-etc-resolv-conf-Device-or-resource-busy错误的处理原因及方式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张奇怪">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张奇怪的blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/04/docker中执行sed-can-t-move-etc-resolv-conf73UqmG-to-etc-resolv-conf-Device-or-resource-busy错误的处理原因及方式/" itemprop="url">docker中执行sed: can't move '/etc/resolv.conf73UqmG' to '/etc/resolv.conf': Device or resource busy错误的处理原因及方式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-06-04T11:37:43+08:00">
                2019-06-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/docker/" itemprop="url" rel="index">
                    <span itemprop="name">docker</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="错误现象"><a href="#错误现象" class="headerlink" title="错误现象"></a>错误现象</h2><p>在docker容器中想要修改/etc/resolv.conf中的namesever，使用sed命令进行执行时遇到错误：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># sed -i &apos;s/192.168.1.1/192.168.1.254/g&apos; /etc/resolv.conf</span><br><span class="line">sed: can&apos;t move &apos;/etc/resolv.conf73UqmG&apos; to &apos;/etc/resolv.conf&apos;: Device or resource busy</span><br></pre></td></tr></table></figure>
<p>但是可以通过vi/vim直接修改这个文件/etc/resolv.conf这个文件的内容。</p>
<h2 id="问题原因"><a href="#问题原因" class="headerlink" title="问题原因"></a>问题原因</h2><p>sed命令的实质并不是修改文件，而是产生一个新的文件替换原有的文件。这里我们做了一个实验。</p>
<p>我先创建了一个<code>test.txt</code>的文件，文件内容是<code>123</code>。然后我使用sed命令对文件内容进行了替换。再次查看<code>test.txt</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># stat test.txt </span><br><span class="line">  File: test.txt</span><br><span class="line">  Size: 4             Blocks: 8          IO Block: 4096   regular file</span><br><span class="line">Device: fd28h/64808d    Inode: 265         Links: 1</span><br><span class="line">Access: (0644/-rw-r--r--)  Uid: (    0/    root)   Gid: (    0/    root)</span><br><span class="line">Access: 2017-07-04 06:28:35.000000000</span><br><span class="line">Modify: 2017-07-04 06:28:17.000000000</span><br><span class="line">Change: 2017-07-04 06:29:03.000000000</span><br><span class="line"># cat test.txt </span><br><span class="line">123</span><br><span class="line"># sed -i &apos;s/123/321/g&apos; test.txt</span><br><span class="line"># stat test.txt </span><br><span class="line">  File: test.txt</span><br><span class="line">  Size: 4             Blocks: 8          IO Block: 4096   regular file</span><br><span class="line">Device: fd28h/64808d    Inode: 266         Links: 1</span><br><span class="line">Access: (0644/-rw-r--r--)  Uid: (    0/    root)   Gid: (    0/    root)</span><br><span class="line">Access: 2017-07-04 06:29:31.000000000</span><br><span class="line">Modify: 2017-07-04 06:29:31.000000000</span><br><span class="line">Change: 2017-07-04 06:29:31.000000000</span><br><span class="line"># cat test.txt</span><br><span class="line">321</span><br></pre></td></tr></table></figure>
<p>可以看到文件内容被正确修改了，但是同时，文件的inode也修改了。说明了实质上是新生成的文件替换了原有的文件。但是vim/vi是在原文件基础上修改的，所以inode没有变化。</p>
<p>在docker中，<code>/etc/resolv.conf</code>是通过挂载入容器的。所以当你想去删除这个挂载文件，也就是挂载点时，自然就会报<code>Device or resource busy</code>。</p>
<blockquote>
<p>这个跟是不是特权privilege没有关系。即使是privilege的容器，也会有这个问题。 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; # rm /etc/resolv.conf </span><br><span class="line">&gt; rm: can&apos;t remove &apos;/etc/resolv.conf&apos;: Device or resource busy</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
</blockquote>
<p>其实不仅仅<code>/etc/resolv.conf</code>，还有<code>/etc/hostname</code>，<code>/etc/hosts</code>等文件都是通过挂载方式挂载到容器中来的。所以想要用<code>sed</code>对他们进行修改，都会遇到这样的问题。我们可以通过<code>df -h</code>查看容器内的挂载情况。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># df -h</span><br><span class="line">Filesystem                Size      Used Available Use% Mounted on</span><br><span class="line">/dev/mapper/docker-253:2-807144231-37acfcd86387ddcbc52ef8dac69d919283fc5d9d8ab5f55fd23d1c782e3b1c70</span><br><span class="line">                         10.0G     33.8M     10.0G   0% /</span><br><span class="line">tmpfs                    15.4G         0     15.4G   0% /dev</span><br><span class="line">tmpfs                    15.4G         0     15.4G   0% /sys/fs/cgroup</span><br><span class="line">/dev/mapper/centos-home</span><br><span class="line">                        212.1G    181.8G     30.3G  86% /run/secrets</span><br><span class="line">/dev/mapper/centos-home</span><br><span class="line">                        212.1G    181.8G     30.3G  86% /dev/termination-log</span><br><span class="line">/dev/mapper/centos-home</span><br><span class="line">                        212.1G    181.8G     30.3G  86% /etc/resolv.conf</span><br><span class="line">/dev/mapper/centos-home</span><br><span class="line">                        212.1G    181.8G     30.3G  86% /etc/hostname</span><br><span class="line">/dev/mapper/centos-home</span><br><span class="line">                        212.1G    181.8G     30.3G  86% /etc/hosts</span><br><span class="line">shm                      64.0M         0     64.0M   0% /dev/shm</span><br><span class="line">tmpfs                    15.4G         0     15.4G   0% /proc/kcore</span><br><span class="line">tmpfs                    15.4G         0     15.4G   0% /proc/timer_stats</span><br></pre></td></tr></table></figure>
<h2 id="如何解决"><a href="#如何解决" class="headerlink" title="如何解决"></a>如何解决</h2><p>使用vi固然可以，但是对于批量操作就不是很合适了。可以通过<code>sed</code>和<code>echo</code>的组合命令<code>echo &quot;$(sed &#39;s/192.168.1.1/192.168.1.254/g&#39; /etc/resolv.conf)&quot; &gt;  /etc/resolv.conf</code> 即可实现替换。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># cat /etc/resolv.conf </span><br><span class="line">search default.svc.games.local svc.games.local games.local</span><br><span class="line">nameserver 192.168.1.1</span><br><span class="line">options ndots:5</span><br><span class="line"># echo &quot;$(sed &apos;s/192.168.1.1/192.168.1.254/g&apos; /etc/resolv.conf)&quot; &gt;  /etc/resolv.conf</span><br><span class="line"># cat /etc/resolv.conf </span><br><span class="line">search default.svc.games.local svc.games.local games.local</span><br><span class="line">nameserver 192.168.1.254</span><br><span class="line">options ndots:5</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>这里如果使用<code>sed &#39;s/192.168.1.1/192.168.1.254/g&#39; /etc/resolv.conf &gt; /etc/resolv.conf</code>是无效的。最终会导致<code>/etc/resolv.conf</code>内容为空。</li>
<li><code>echo</code> 命令后面需要加双引号，不然会导致换行的缺失</li>
</ul>
</blockquote>
<hr>
<p>作者：xuxinkun </p>
<p>出处：xinkun的博客 </p>
<p>链接：<a href="https://xuxinkun.github.io/" target="_blank" rel="noopener">https://xuxinkun.github.io/</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhanghongtong.github.io/2018/10/30/Kunbernetes安装部署工具Helm，使用helm管理与发布kubernetes应用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张奇怪">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张奇怪的blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/30/Kunbernetes安装部署工具Helm，使用helm管理与发布kubernetes应用/" itemprop="url">Kunbernetes安装部署工具Helm，使用helm管理与发布kubernetes应用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-10-30T15:32:30+08:00">
                2018-10-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/kubernetes/" itemprop="url" rel="index">
                    <span itemprop="name">kubernetes</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Helm介绍"><a href="#Helm介绍" class="headerlink" title="Helm介绍"></a>Helm介绍</h1><p>Helm是管理Kubernetes包的工具，Helm能提供下面的能力：</p>
<ul>
<li>创建新的charts</li>
<li>将charts打包成tgz文件</li>
<li>与chart仓库交互</li>
<li>安装和卸载Kubernetes的应用</li>
<li>管理使用Helm安装的charts的生命周期</li>
</ul>
<p>在Helm中，有三个需要了解的重要概念：</p>
<ul>
<li>chart：是创建Kubernetes应用实例的信息集合；</li>
<li>config：创建发布对象的chart的配置信息</li>
<li>release：chart的运行实例，包含特定的config</li>
</ul>
<h2 id="Helm组件"><a href="#Helm组件" class="headerlink" title="Helm组件"></a>Helm组件</h2><p>在Helm中有两个主要的组件，既Helm客户端和Tiller服务器：</p>
<p><strong>Helm客户端</strong>：这是一个供终端用户使用的命令行工具，客户端负责如下的工作：</p>
<ul>
<li>本地chart开发</li>
<li>管理仓库</li>
<li>与Tiller服务器交互<ul>
<li>发送需要被安装的charts</li>
<li>请求关于发布版本的信息</li>
<li>请求更新或者卸载已安装的发布版本</li>
</ul>
</li>
</ul>
<p><strong>Tiller服务器</strong>： Tiller服务部署在Kubernetes集群中，Helm客户端通过与Tiller服务器进行交互，并最终与Kubernetes API服务器进行交互。 Tiller服务器负责如下的工作：</p>
<ul>
<li>监听来自于Helm客户端的请求</li>
<li>组合chart和配置来构建一个发布</li>
<li>在Kubernetes中安装，并跟踪后续的发布</li>
<li>通过与Kubernetes交互，更新或者chart</li>
</ul>
<p>客户端负责管理chart，服务器发展管理发布。 </p>
<h2 id="Helm技术实现"><a href="#Helm技术实现" class="headerlink" title="Helm技术实现"></a>Helm技术实现</h2><p>Helm客户端是使用Go语言编写的，它通过gRPC协议与Tiller服务器交互。</p>
<p>Tiller服务器也是使用Go语言编写的，它使用Kubernetes客户端类库（当前是哦那个REST+JSON）与Kubernetes进行通讯。</p>
<p>Tiller服务器通过Kubernetes的ConfigMap存储信息，因此本身没有用于存储数据库。</p>
<h1 id="Helm安装部署"><a href="#Helm安装部署" class="headerlink" title="Helm安装部署"></a>Helm安装部署</h1><h2 id="安装Helm客户端"><a href="#安装Helm客户端" class="headerlink" title="安装Helm客户端"></a>安装Helm客户端</h2><p>在进行Helm客户端安装前，请确认已有可用的Kubernetes集群环境，并已安装了kubectl。</p>
<p>通过访问：<a href="https://github.com/kubernetes/helm/releases。" target="_blank" rel="noopener">https://github.com/kubernetes/helm/releases。</a><br>下载Helm的合适的版本。</p>
<ol>
<li>此文下载helm-v2.8.0-linux-amd64.tgz版本；</li>
<li>解压缩文件：tar -zxvf helm-v2.8.0-linux-amd64.tgz</li>
<li>将解压缩后的helm移至/usr/local/bin目录下：mv linux-amd64/helm /usr/local/bin/helm</li>
</ol>
<p><strong>注意</strong>：</p>
<ul>
<li>最好在安装kubectl命令行工具的机器上安装Helm客户端；或者将安装kubectl命令行工具生成的配置文件（$HOME/.kube/config）复制到Helm客户端所安装的机器上($HOME/.kube/config)。</li>
</ul>
<h2 id="安装Tiller服务器"><a href="#安装Tiller服务器" class="headerlink" title="安装Tiller服务器"></a>安装Tiller服务器</h2><h3 id="使用Service-Account安装"><a href="#使用Service-Account安装" class="headerlink" title="使用Service Account安装"></a>使用Service Account安装</h3><ol>
<li><p>创建一个名为tiller的Service Account</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create serviceaccount tiller --namespace kube-system</span><br></pre></td></tr></table></figure>
</li>
<li><p>授予名为tiller的Service Account集群管理员角色cluster-admin:</p>
<ul>
<li><p>将tiller绑定至集群管理员角色的的yaml文件如下所示：</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$vim rbac-config.yaml</span><br><span class="line"></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1 </span><br><span class="line">kind: ClusterRoleBinding </span><br><span class="line">metadata: </span><br><span class="line">  name: tiller </span><br><span class="line">roleRef: </span><br><span class="line">  apiGroup: rbac.authorization.k8s.io </span><br><span class="line">  kind: ClusterRole </span><br><span class="line">  name: cluster-admin </span><br><span class="line">subjects: </span><br><span class="line">- kind: ServiceAccount </span><br><span class="line">  name: tiller </span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过执行kubectl create -f将授予tiller集群管理员角色：</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f rbac-config.yaml</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>安装Tiller服务器</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ helm init --service-account tiller</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="验证安装"><a href="#验证安装" class="headerlink" title="验证安装"></a>验证安装</h3><p>在安装完成后，可以通过执行如下命令来检查是安装成功：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ helm version</span><br></pre></td></tr></table></figure></p>
<p>如果正确显示Helm客户端和Tiller服务器的版本，这表示安装成功。</p>
<p>或者通过执行kubectl的如下命令来查看是否已正常按照Tiller服务器：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -n kube-system</span><br></pre></td></tr></table></figure></p>
<h1 id="Helm使用"><a href="#Helm使用" class="headerlink" title="Helm使用"></a>Helm使用</h1><h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><h3 id="查看源"><a href="#查看源" class="headerlink" title="查看源"></a>查看源</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">helm repo list    #列出所有源，当前还没有添加源</span><br><span class="line"># 添加一个国内可以访问的阿里源，不过好像最近不更新了</span><br><span class="line">helm repo add ali https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts  </span><br><span class="line">如果能连外网，可以加google，f8</span><br><span class="line">helm repo add google https://kubernetes-charts.storage.googleapis.com </span><br><span class="line">helm repo add fabric8 https://fabric8.io/helm</span><br><span class="line"># 更新源</span><br><span class="line">helm repo update</span><br></pre></td></tr></table></figure>
<h3 id="查看chart"><a href="#查看chart" class="headerlink" title="查看chart"></a>查看chart</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 查看chart，即已经通过helm部署到 k8s 平台的应用</span><br><span class="line">helm list    或者  helm ls</span><br><span class="line"></span><br><span class="line"># 若要查看或搜索存储库中的 Helm charts，键入以下任一命令</span><br><span class="line">helm search </span><br><span class="line">helm search 存储库名称 #如 stable 或 incubator</span><br><span class="line">helm search chart名称 #如 wordpress 或 spark</span><br><span class="line"></span><br><span class="line"># 查看charm详情</span><br><span class="line">helm inspect ali/wordpress</span><br></pre></td></tr></table></figure>
<h3 id="下载chart"><a href="#下载chart" class="headerlink" title="下载chart"></a>下载chart</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm fetch ali/wordpress</span><br><span class="line">[ubuntu@master1 ~]# ls wordpress-0.8.8.tgz </span><br><span class="line">wordpress-0.8.8.tgz</span><br></pre></td></tr></table></figure>
<h3 id="部署应用-wordpress，-通过ali源文件"><a href="#部署应用-wordpress，-通过ali源文件" class="headerlink" title="部署应用 wordpress， 通过ali源文件"></a>部署应用 wordpress， 通过ali源文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ helm install --name wordpress-test --set &quot;persistence.enabled=false,mariadb.persistence.enabled=false&quot; ali/wordpress</span><br><span class="line"></span><br><span class="line">[ubuntu@master1 ~]# kubectl get pod </span><br><span class="line">NAME                                        READY     STATUS    RESTARTS   AGE</span><br><span class="line">wordpress-test-mariadb-84b866bf95-7bx5w     1/1       Running   1          4h</span><br><span class="line">wordpress-test-wordpress-5ff8c64b6c-hrh9q   1/1       Running   0          4h</span><br><span class="line">[ubuntu@master1 ~]# kubectl get svc </span><br><span class="line">NAME                       TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE</span><br><span class="line">kubernetes                 ClusterIP      10.96.0.1        &lt;none&gt;        443/TCP                      2d</span><br><span class="line">wordpress-test-mariadb     ClusterIP      10.105.71.95     &lt;none&gt;        3306/TCP                     4h</span><br><span class="line">wordpress-test-wordpress   LoadBalancer   10.104.106.150   &lt;pending&gt;     80:30655/TCP,443:32121/TCP   4h</span><br></pre></td></tr></table></figure>
<h3 id="访问wordpress，使用node节点ip-nodeport，-192-168-1-181-30655"><a href="#访问wordpress，使用node节点ip-nodeport，-192-168-1-181-30655" class="headerlink" title="访问wordpress，使用node节点ip + nodeport， 192.168.1.181:30655"></a>访问wordpress，使用node节点ip + nodeport， 192.168.1.181:30655</h3><h3 id="删除应用"><a href="#删除应用" class="headerlink" title="删除应用"></a>删除应用</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[ubuntu@master1 ~]# helm list</span><br><span class="line">NAME            REVISION    UPDATED                     STATUS      CHART           NAMESPACE</span><br><span class="line">wordpress-test  1           Thu May 17 11:35:07 2018    DEPLOYED    wordpress-0.8.8 default  </span><br><span class="line">[ubuntu@master1 ~]# helm delete wordpress-test</span><br><span class="line">release &quot;wordpress-test&quot; deleted</span><br></pre></td></tr></table></figure>
<h1 id="建立自己的chart"><a href="#建立自己的chart" class="headerlink" title="建立自己的chart"></a>建立自己的chart</h1><p>创建一个自己的chart，看下文档结构，学习下如何使用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ helm create emqx</span><br><span class="line">Creating emqx</span><br><span class="line">$ tree misa86</span><br><span class="line">emqx</span><br><span class="line">├── charts     #Chart本身的版本和配置信息</span><br><span class="line">├── Chart.yaml    #Chart本身的版本和配置信息</span><br><span class="line">├── templates    #配置模板目录</span><br><span class="line">│   ├── deployment.yaml    #kubernetes Deployment object</span><br><span class="line">│   ├── _helpers.tpl    #用于修改kubernetes objcet配置的模板</span><br><span class="line">│   ├── ingress.yaml    #kubernetes Deployment object</span><br><span class="line">│   ├── NOTES.txt    #helm提示信息</span><br><span class="line">│   └── service.yaml    #kubernetes Serivce</span><br><span class="line">└── values.yaml    #kubernetes object configuration，定义变量</span><br></pre></td></tr></table></figure></p>
<h2 id="模板-template"><a href="#模板-template" class="headerlink" title="模板 template"></a>模板 template</h2><p>template下包含应用所有的yaml文件模板，应用资源的类型不仅限于deployment 和service这些，k8s支持的都可以<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">$cat templates/deployment.yaml</span><br><span class="line"></span><br><span class="line">apiVersion: apps/v1beta2</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: &#123;&#123; include &quot;emqx.fullname&quot; . &#125;&#125;</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: &#123;&#123; include &quot;emqx.name&quot; . &#125;&#125;</span><br><span class="line">    helm.sh/chart: &#123;&#123; include &quot;emqx.chart&quot; . &#125;&#125;</span><br><span class="line">    app.kubernetes.io/instance: &#123;&#123; .Release.Name &#125;&#125;</span><br><span class="line">    app.kubernetes.io/managed-by: &#123;&#123; .Release.Service &#125;&#125;</span><br><span class="line">spec:</span><br><span class="line">  replicas: &#123;&#123; .Values.replicaCount &#125;&#125;</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app.kubernetes.io/name: &#123;&#123; include &quot;emqx.name&quot; . &#125;&#125;</span><br><span class="line">      app.kubernetes.io/instance: &#123;&#123; .Release.Name &#125;&#125;</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app.kubernetes.io/name: &#123;&#123; include &quot;emqx.name&quot; . &#125;&#125;</span><br><span class="line">        app.kubernetes.io/instance: &#123;&#123; .Release.Name &#125;&#125;</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: &#123;&#123; .Chart.Name &#125;&#125;</span><br><span class="line">          image: &quot;&#123;&#123; .Values.image.repository &#125;&#125;:&#123;&#123; .Values.image.tag &#125;&#125;&quot;</span><br><span class="line">          imagePullPolicy: &#123;&#123; .Values.image.pullPolicy &#125;&#125;</span><br><span class="line">          ports:</span><br><span class="line">          - containerPort: 1883</span><br><span class="line">          - containerPort: 8883</span><br><span class="line">          - containerPort: 8080</span><br><span class="line">          - containerPort: 18083</span><br><span class="line">          - containerPort: 4369</span><br><span class="line">          - containerPort: 4370</span><br><span class="line">          - containerPort: 6369</span><br><span class="line">          - containerPort: 6370</span><br><span class="line">          - containerPort: 6371</span><br><span class="line">          - containerPort: 6372</span><br><span class="line">          - containerPort: 6373</span><br><span class="line">          - containerPort: 6374</span><br><span class="line">          - containerPort: 6375</span><br><span class="line">          - containerPort: 6376</span><br><span class="line">          - containerPort: 6377</span><br><span class="line">          - containerPort: 6378</span><br><span class="line">          env:</span><br><span class="line">          - name: EMQX_NAME</span><br><span class="line">            value: emqx</span><br><span class="line">          - name: EMQX_CLUSTER__K8S__APP_NAME</span><br><span class="line">            value: emqx</span><br><span class="line">          - name: EMQX_CLUSTER__DISCOVERY</span><br><span class="line">            value: k8s</span><br><span class="line">          - name: EMQX_CLUSTER__K8S__SERVICE_NAME</span><br><span class="line">            value: &#123;&#123; include &quot;emqx.fullname&quot; . &#125;&#125;</span><br><span class="line">          - name: EMQX_CLUSTER__K8S__APISERVER</span><br><span class="line">            value: &#123;&#123; .Values.env.kubeApiserver &#125;&#125;</span><br><span class="line">          - name: EMQX_CLUSTER__K8S__NAMESPACE</span><br><span class="line">            value: &#123;&#123; .Values.env.kubeNamespace &#125;&#125;</span><br><span class="line">          - name: EMQX_CLUSTER__K8S__ADDRESS_TYPE</span><br><span class="line">            value: &#123;&#123; .Values.env.kubeAddressType &#125;&#125;</span><br><span class="line">          - name: EMQX_CLUSTER__K8S__APP_NAME</span><br><span class="line">            value: emqx</span><br><span class="line">          tty: true</span><br></pre></td></tr></table></figure></p>
<p>这是该应用的Deployment的yaml配置文件，其中的双大括号包扩起来的部分是Go template， template “emqx.name” 这类是在 _helpers.tpl 文件中定义的，如果不定义，将来文件名会是随意字符加chart名字。</p>
<p>其中的Values是在values.yaml文件中定义的，应用主要的参数在这边：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">$ cat values.yaml</span><br><span class="line"># Default values for emqx.</span><br><span class="line"># This is a YAML-formatted file.</span><br><span class="line"># Declare variables to be passed into your templates.</span><br><span class="line"></span><br><span class="line">replicaCount: 2</span><br><span class="line"></span><br><span class="line">image:</span><br><span class="line">  repository: emqx/emqx</span><br><span class="line">  tag: latest</span><br><span class="line">  pullPolicy: IfNotPresent</span><br><span class="line"></span><br><span class="line">env:</span><br><span class="line">  kubeApiserver: http://127.0.0.1:8080</span><br><span class="line">  kubeNamespace: default</span><br><span class="line">  kubeAddressType: ip</span><br><span class="line"></span><br><span class="line">service:</span><br><span class="line">  type: ClusterIP</span><br><span class="line">  mqttPort: 1883</span><br><span class="line">  mqttsslPort: 8883</span><br><span class="line">  mgmtPort: 8080</span><br><span class="line">  dashboardPort: 18083</span><br><span class="line">  mappingPort: 4369</span><br><span class="line"></span><br><span class="line">ingress:</span><br><span class="line">  enabled: false</span><br><span class="line">  annotations: &#123;&#125;</span><br><span class="line">    # kubernetes.io/ingress.class: nginx</span><br><span class="line">    # kubernetes.io/tls-acme: &quot;true&quot;</span><br><span class="line">  path: /</span><br><span class="line">  hosts:</span><br><span class="line">    - chart-example.local</span><br><span class="line">  tls: []</span><br><span class="line">  #  - secretName: chart-example-tls</span><br><span class="line">  #    hosts:</span><br><span class="line">  #      - chart-example.local</span><br></pre></td></tr></table></figure></p>
<p>比如在Deployment.yaml中定义的容器镜像image:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; .Values.image.repository &#125;&#125;:&#123;&#123; .Values.image.tag &#125;&#125;</span><br></pre></td></tr></table></figure></p>
<p>其中的：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.Values.image.repository就是emqx/emqx</span><br><span class="line">.Values.image.tag就是latest</span><br></pre></td></tr></table></figure></p>
<p>以上两个变量值是在install chart的时候自动生成的默认值。</p>
<h2 id="检查配置和模板是否有效"><a href="#检查配置和模板是否有效" class="headerlink" title="检查配置和模板是否有效"></a>检查配置和模板是否有效</h2><p>当使用kubernetes部署应用的时候实际上将templates渲染成最终的kubernetes能够识别的yaml格式。</p>
<p>使用<code>helm install --dry-run --debug &lt;chart_dir&gt;</code>命令来验证chart配置。该输出中包含了模板的变量配置与最终渲染的yaml文件。 deployment service的名字前半截由两个随机的单词组成，随机数加chart名。 这名字也可以改成value方式，自己定义<br>如果配置等有问题此处会报错<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line">helm install --set env.kubeApiserver=http://172.31.31.241:8080 --dry-run --debug .</span><br><span class="line">[debug] Created tunnel using local port: &apos;43251&apos;</span><br><span class="line"></span><br><span class="line">[debug] SERVER: &quot;127.0.0.1:43251&quot;</span><br><span class="line"></span><br><span class="line">[debug] Original chart version: &quot;&quot;</span><br><span class="line">[debug] CHART PATH: /home/ubuntu/emqx-helm</span><br><span class="line"></span><br><span class="line">NAME:   quelling-toad</span><br><span class="line">REVISION: 1</span><br><span class="line">RELEASED: Tue Oct 30 08:18:09 2018</span><br><span class="line">CHART: emqx-helm-v1.0</span><br><span class="line">USER-SUPPLIED VALUES:</span><br><span class="line">env:</span><br><span class="line">  kubeApiserver: http://172.31.31.241:8080</span><br><span class="line"></span><br><span class="line">COMPUTED VALUES:</span><br><span class="line">env:</span><br><span class="line">  kubeAddressType: ip</span><br><span class="line">  kubeApiserver: http://172.31.31.241:8080</span><br><span class="line">  kubeNamespace: default</span><br><span class="line">image:</span><br><span class="line">  pullPolicy: IfNotPresent</span><br><span class="line">  tag: latest</span><br><span class="line">ingress:</span><br><span class="line">  annotations: &#123;&#125;</span><br><span class="line">  enabled: false</span><br><span class="line">  hosts:</span><br><span class="line">  - chart-example.local</span><br><span class="line">  path: /</span><br><span class="line">  tls: []</span><br><span class="line">replicaCount: 2</span><br><span class="line">service:</span><br><span class="line">  dashboardPort: 18083</span><br><span class="line">  mappingPort: 4369</span><br><span class="line">  mgmtPort: 8080</span><br><span class="line">  mqttPort: 1883</span><br><span class="line">  mqttsslPort: 8883</span><br><span class="line">  type: ClusterIP</span><br><span class="line"></span><br><span class="line">HOOKS:</span><br><span class="line">MANIFEST:</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"># Source: emqx-helm/templates/service.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: quelling-toad-emqx-helm</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: emqx-helm</span><br><span class="line">    helm.sh/chart: emqx-helm-v1.0</span><br><span class="line">    app.kubernetes.io/instance: quelling-toad</span><br><span class="line">    app.kubernetes.io/managed-by: Tiller</span><br><span class="line">spec:</span><br><span class="line">  type: ClusterIP</span><br><span class="line">  ports:</span><br><span class="line">  - name: mqtt</span><br><span class="line">    port: 1883</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 1883</span><br><span class="line">  - name: mqttssl</span><br><span class="line">    port: 8883</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 8883</span><br><span class="line">  - name: mgmt</span><br><span class="line">    port: 8080</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 8080</span><br><span class="line">  - name: dashboard</span><br><span class="line">    port: 18083</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 18083</span><br><span class="line">  - name: mapping</span><br><span class="line">    port: 4369</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 4369</span><br><span class="line">  selector:</span><br><span class="line">    app.kubernetes.io/name: emqx-helm</span><br><span class="line">    app.kubernetes.io/instance: quelling-toad</span><br><span class="line">---</span><br><span class="line"># Source: emqx-helm/templates/deployment.yaml</span><br><span class="line">apiVersion: apps/v1beta2</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: quelling-toad-emqx-helm</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: emqx-helm</span><br><span class="line">    helm.sh/chart: emqx-helm-v1.0</span><br><span class="line">    app.kubernetes.io/instance: quelling-toad</span><br><span class="line">    app.kubernetes.io/managed-by: Tiller</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app.kubernetes.io/name: emqx-helm</span><br><span class="line">      app.kubernetes.io/instance: quelling-toad</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app.kubernetes.io/name: emqx-helm</span><br><span class="line">        app.kubernetes.io/instance: quelling-toad</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: emqx-helm</span><br><span class="line">          image: &quot;emqx/emqx:latest&quot;</span><br><span class="line">          imagePullPolicy: IfNotPresent</span><br><span class="line">          ports:</span><br><span class="line">          - containerPort: 1883</span><br><span class="line">          - containerPort: 8883</span><br><span class="line">          - containerPort: 8080</span><br><span class="line">          - containerPort: 18083</span><br><span class="line">          - containerPort: 4369</span><br><span class="line">          - containerPort: 4370</span><br><span class="line">          - containerPort: 6369</span><br><span class="line">          - containerPort: 6370</span><br><span class="line">          - containerPort: 6371</span><br><span class="line">          - containerPort: 6372</span><br><span class="line">          - containerPort: 6373</span><br><span class="line">          - containerPort: 6374</span><br><span class="line">          - containerPort: 6375</span><br><span class="line">          - containerPort: 6376</span><br><span class="line">          - containerPort: 6377</span><br><span class="line">          - containerPort: 6378</span><br><span class="line">          env:</span><br><span class="line">          - name: EMQX_NAME</span><br><span class="line">            value: emqx</span><br><span class="line">          - name: EMQX_CLUSTER__K8S__APP_NAME</span><br><span class="line">            value: emqx</span><br><span class="line">          - name: EMQX_CLUSTER__DISCOVERY</span><br><span class="line">            value: k8s</span><br><span class="line">          - name: EMQX_CLUSTER__K8S__SERVICE_NAME</span><br><span class="line">            value: quelling-toad-emqx-helm</span><br><span class="line">          - name: EMQX_CLUSTER__K8S__APISERVER</span><br><span class="line">            value: http://172.31.31.241:8080</span><br><span class="line">          - name: EMQX_CLUSTER__K8S__NAMESPACE</span><br><span class="line">            value: default</span><br><span class="line">          - name: EMQX_CLUSTER__K8S__ADDRESS_TYPE</span><br><span class="line">            value: ip</span><br><span class="line">          - name: EMQX_CLUSTER__K8S__APP_NAME</span><br><span class="line">            value: emqx</span><br><span class="line">          tty: true</span><br></pre></td></tr></table></figure></p>
<h2 id="部署到kubernetes"><a href="#部署到kubernetes" class="headerlink" title="部署到kubernetes"></a>部署到kubernetes</h2><p>在emqx目录下执行下面的命令将应用部署到kubernetes集群上。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ helm install --set env.kubeApiserver=http://172.31.31.241:8080 .</span><br><span class="line">NAME:   ugly-bumblebee</span><br><span class="line">LAST DEPLOYED: Tue Oct 30 08:19:17 2018</span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: DEPLOYED</span><br><span class="line"></span><br><span class="line">RESOURCES:</span><br><span class="line">==&gt; v1/Service</span><br><span class="line">NAME                      AGE</span><br><span class="line">ugly-bumblebee-emqx-helm  0s</span><br><span class="line"></span><br><span class="line">==&gt; v1beta2/Deployment</span><br><span class="line">ugly-bumblebee-emqx-helm  0s</span><br><span class="line"></span><br><span class="line">==&gt; v1/Pod(related)</span><br><span class="line"></span><br><span class="line">NAME                                       READY  STATUS             RESTARTS  AGE</span><br><span class="line">ugly-bumblebee-emqx-helm-5bc599849f-n4htc  0/1    ContainerCreating  0         0s</span><br><span class="line">ugly-bumblebee-emqx-helm-5bc599849f-xwdn7  0/1    ContainerCreating  0         0s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NOTES:</span><br><span class="line">1. Get the application URL by running these commands:</span><br><span class="line">  export POD_NAME=$(kubectl get pods --namespace default -l &quot;app.kubernetes.io/name=emqx-helm,app.kubernetes.io/instance=ugly-bumblebee&quot; -o jsonpath=&quot;&#123;.items[0].metadata.name&#125;&quot;)</span><br><span class="line">  echo &quot;Visit http://127.0.0.1:8080 to use your application&quot;</span><br><span class="line">  kubectl port-forward $POD_NAME 8080:80</span><br></pre></td></tr></table></figure></p>
<h2 id="查看部署的relaese"><a href="#查看部署的relaese" class="headerlink" title="查看部署的relaese"></a>查看部署的relaese</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ helm list</span><br><span class="line">NAME           	REVISION	UPDATED                 	STATUS  	CHART         	APP VERSION	NAMESPACE</span><br><span class="line">ugly-bumblebee 	1       	Tue Oct 30 08:19:17 2018	DEPLOYED	emqx-helm-v1.0	v1.0       	default</span><br><span class="line"></span><br><span class="line">$ helm delete ugly-bumblebee</span><br><span class="line">release &quot;ugly-bumblebee&quot; deleted</span><br></pre></td></tr></table></figure>
<h2 id="打包分享"><a href="#打包分享" class="headerlink" title="打包分享"></a>打包分享</h2><p>我们可以修改Chart.yaml中的helm chart配置信息，然后使用下列命令将chart打包成一个压缩文件。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ helm package .</span><br><span class="line">Successfully packaged chart and saved it to: /home/ubuntu/emqx/emqx-v1.0.tgz</span><br></pre></td></tr></table></figure></p>
<h1 id="Chart-Repository"><a href="#Chart-Repository" class="headerlink" title="Chart Repository"></a>Chart Repository</h1><p>chart 库是带有一个 index.yaml 文件和任意个打包 cahrt 的 HTTP 服务器。当准备好分享 chart 时，首选方法是将其上传到 chart 库。</p>
<p>由于 chart 库可以是任何可以提供 YAML 和 tar 文件并可以回答 GET 请求的 HTTP 服务器，因此当托管自己的 chart 库时，很多选择。例如，可以使用 Google 云端存储（GCS）存储桶，Amazon S3 存储桶，Github Pages，甚至可以创建自己的 Web 服务器。</p>
<h2 id="创建-chart-库"><a href="#创建-chart-库" class="headerlink" title="创建 chart 库"></a>创建 chart 库</h2><h3 id="chart-库结构"><a href="#chart-库结构" class="headerlink" title="chart 库结构"></a>chart 库结构</h3><p>chart 库由打包的 chart 和一个名为的特殊文件组成， index.yaml 其中包含 chart 库中所有 chart 的索引。通常，index.yaml 描述的 chart 也是托管在同一台服务器上，源代码文件也是如此。</p>
<p>例如，chart 库的布局 <a href="https://example.com/charts" target="_blank" rel="noopener">https://example.com/charts</a> 可能如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">charts/</span><br><span class="line">  |</span><br><span class="line">  |- index.yaml</span><br><span class="line">  |</span><br><span class="line">  |- alpine-0.1.2.tgz</span><br><span class="line">  |</span><br><span class="line">  |- alpine-0.1.2.tgz.prov</span><br></pre></td></tr></table></figure></p>
<p>这种情况下，索引文件包含有关一个 chart（Alpine chart）的信息，并提供该 chart 的下载 URL <a href="https://example.com/charts/alpine-0.1.2.tgz。" target="_blank" rel="noopener">https://example.com/charts/alpine-0.1.2.tgz。</a></p>
<p>不要求 chart 包与 index.yaml 文件位于同一台服务器上 。但是，发在一起这样做通常是最简单的。</p>
<h3 id="索引文件"><a href="#索引文件" class="headerlink" title="索引文件"></a>索引文件</h3><p>索引文件是一个叫做 yaml 文件 index.yaml。它包含一些关于包的元数据，包括 chart 的 Chart.yaml 文件的内容。一个有效的 chart 库必须有一个索引文件。索引文件包含有关 chart 库中每个 chart 的信息。helm repo index 命令将根据包含打包的 chart 的给定本地目录生成索引文件。</p>
<p>下面一个索引文件的例子：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">entries:</span><br><span class="line">  alpine:</span><br><span class="line">    - created: 2016-10-06T16:23:20.499814565-06:00</span><br><span class="line">      description: Deploy a basic Alpine Linux pod</span><br><span class="line">      digest: 99c76e403d752c84ead610644d4b1c2f2b453a74b921f422b9dcb8a7c8b559cd</span><br><span class="line">      home: https://k8s.io/helm</span><br><span class="line">      name: alpine</span><br><span class="line">      sources:</span><br><span class="line">      - https://github.com/kubernetes/helm</span><br><span class="line">      urls:</span><br><span class="line">      - https://technosophos.github.io/tscharts/alpine-0.2.0.tgz</span><br><span class="line">      version: 0.2.0</span><br><span class="line">    - created: 2016-10-06T16:23:20.499543808-06:00</span><br><span class="line">      description: Deploy a basic Alpine Linux pod</span><br><span class="line">      digest: 515c58e5f79d8b2913a10cb400ebb6fa9c77fe813287afbacf1a0b897cd78727</span><br><span class="line">      home: https://k8s.io/helm</span><br><span class="line">      name: alpine</span><br><span class="line">      sources:</span><br><span class="line">      - https://github.com/kubernetes/helm</span><br><span class="line">      urls:</span><br><span class="line">      - https://technosophos.github.io/tscharts/alpine-0.1.0.tgz</span><br><span class="line">      version: 0.1.0</span><br><span class="line">  nginx:</span><br><span class="line">    - created: 2016-10-06T16:23:20.499543808-06:00</span><br><span class="line">      description: Create a basic nginx HTTP server</span><br><span class="line">      digest: aaff4545f79d8b2913a10cb400ebb6fa9c77fe813287afbacf1a0b897cdffffff</span><br><span class="line">      home: https://k8s.io/helm</span><br><span class="line">      name: nginx</span><br><span class="line">      sources:</span><br><span class="line">      - https://github.com/kubernetes/charts</span><br><span class="line">      urls:</span><br><span class="line">      - https://technosophos.github.io/tscharts/nginx-1.1.0.tgz</span><br><span class="line">      version: 1.1.0</span><br><span class="line">generated: 2016-10-06T16:23:20.499029981-06:00</span><br></pre></td></tr></table></figure></p>
<p>生成的索引和包可以从基本的网络服务器提供。可以使用 helm serve 启动本地服务器，在本地测试所有内容。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ helm serve --repo-path ./charts</span><br><span class="line">Regenerating index. This may take a moment.</span><br><span class="line">Now serving you on 127.0.0.1:8879</span><br></pre></td></tr></table></figure></p>
<h2 id="托管-chart-库"><a href="#托管-chart-库" class="headerlink" title="托管 chart 库"></a>托管 chart 库</h2><p>要配置普通 Web 服务器来服务 Helm chart，只需执行以下操作：</p>
<ul>
<li>将索引和 chart 置于服务器目录中</li>
<li>确保 index.yaml 可以在没有认证要求的情况下访问</li>
<li>确保 yaml 文件的正确内容类型（text/yaml 或 text/x-yaml）</li>
</ul>
<p>例如，如果想在 $WEBROOT/charts 以外的目录为 chart 提供服务，请确保 Web 根目录中有一个 charts/ 目录，并将索引文件和 chart 放入该文件夹内。</p>
<h2 id="管理-chart-库"><a href="#管理-chart-库" class="headerlink" title="管理 chart 库"></a>管理 chart 库</h2><h3 id="将-chart-存储在-chart-库中"><a href="#将-chart-存储在-chart-库中" class="headerlink" title="将 chart 存储在 chart 库中"></a>将 chart 存储在 chart 库中</h3><p>现在已有一个 chart 存储库，让我们上传一个 chart 和一个索引文件到存储库。chart 库中的 chart 必须正确打包（helm package chart-name/）和版本（遵循 <a href="https://semver.org/" target="_blank" rel="noopener">SemVer 2</a> 标准）。</p>
<p>接下来的这些步骤是一个示例工作流程，也可以用你喜欢的任何工作流程来存储和更新 chart 库中的 chart。</p>
<p>准备好打包 chart 后，创建一个新目录，并将打包 chart 移动到该目录。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ helm package .</span><br><span class="line">$ mkdir emqx-charts</span><br><span class="line">$ mv emqx-0.1.0.tgz emqx-charts/</span><br><span class="line">$ helm repo index emqx-charts --url  https://example.com/charts</span><br></pre></td></tr></table></figure></p>
<p>最后一条命令采用刚创建的本地目录的路径和远程 chart 库的 URL，并在给定的目录路径中生成 index.yaml。</p>
<p>现在可以使用同步工具或手动将 chart 和索引文件上传到 chart 库。如果使用 Google 云端存储，请使用 gsutil 客户端查看此示例工作流程。对于 GitHub，可以简单地将 chart 放入适当的目标分支中。</p>
<h3 id="新添加-chart-添加到现有存储库"><a href="#新添加-chart-添加到现有存储库" class="headerlink" title="新添加 chart 添加到现有存储库"></a>新添加 chart 添加到现有存储库</h3><p>每次将新 chart 添加到存储库时，都必须重新生成索引。helm repo index 命令将 index.yaml 从头开始完全重建该文件，但仅包括它在本地找到的 chart。</p>
<p>可以使用 –merge 标志向现有 index.yaml 文件增量添加新 chart（在使用远程存储库（如 GCS）时，这是一个很好的选择）。运行 helm repo index –help 以了解更多信息，</p>
<p>确保上传修改后的 index.yaml 文件和 chart。如果生成了出处 provenance 文件，也要上传。</p>
<h3 id="与他人分享-chart"><a href="#与他人分享-chart" class="headerlink" title="与他人分享 chart"></a>与他人分享 chart</h3><p>准备好分享 chart 时，只需让别人知道存储库的 URL 是什么就可以了。</p>
<p>他们将通过 <code>helm repo add [NAME] [URL]</code> 命令将仓库添加到他们的 helm 客户端，并可以起一个带有任何想用来引用仓库的名字。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ helm repo add emqx-charts https://example.com/charts</span><br><span class="line">$ helm repo list</span><br><span class="line">emqx-charts    https://example.com/charts</span><br></pre></td></tr></table></figure></p>
<p>如果 chart 由 HTTP 基本认证支持，也可以在此处提供用户名和密码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ helm repo add emqx-charts https://example.com/charts --username my-username --password my-password</span><br><span class="line">$ helm repo list</span><br><span class="line">emqx-charts    https://example.com/charts</span><br></pre></td></tr></table></figure></p>
<p><strong>注意</strong>： 如果存储库不包含有效信息库 index.yaml 文件，则添加不会成功。</p>
<p>之后，用户将能够搜索 chart。更新存储库后，他们可以使用该 helm repo update 命令获取最新的 chart 信息。</p>
<p>原理是helm repo add和helm repo update命令获取index.yaml文件并将它们存储在 $HELM_HOME/repository/cache/目录中。这是helm search 找到有关chart的信息的地方。</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://whmzsu.github.io/helm-doc-zh-cn/chart/chart_repository-zh_cn.html" target="_blank" rel="noopener">Chart Repository 存储库指南</a></li>
<li><a href="https://www.jianshu.com/p/5db132101a09" target="_blank" rel="noopener">使用Helm管理kubernetes应用</a></li>
<li><a href="https://www.kubernetes.org.cn/4009.html" target="_blank" rel="noopener">Kunbernetes-容器云应用的安装部署工具Helm</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhanghongtong.github.io/2018/10/25/kubernetes1-9安装dashboard，以及token认证问题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张奇怪">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张奇怪的blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/25/kubernetes1-9安装dashboard，以及token认证问题/" itemprop="url">kubernetes1.9安装dashboard，以及token认证问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-10-25T15:13:18+08:00">
                2018-10-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/kubernetes/" itemprop="url" rel="index">
                    <span itemprop="name">kubernetes</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>dashboard的安装非常简单。但按照官网建议的方式安装完成后，输入token登录时会没有反应。 </p>
<p>这个问题困扰了我一整天，最终在<a href="https://github.com/kubernetes/dashboard/issues/2540l" target="_blank" rel="noopener">这里</a>找到了答案。 </p>
<p>原因如下： </p>
<p>按官方文档建议的方式安装完dashboard后，使用kubectl proxy代理的方式来访问webUI。使用这个代理的方式访问就会导致登录无响应的问题。</p>
<p>我们需要将dashboard的service类型改为NodePort,将端口映射到虚拟机上，然后直接通过虚拟机的ip地址登录</p>
<h2 id="安装dashboard"><a href="#安装dashboard" class="headerlink" title="安装dashboard"></a>安装dashboard</h2><h3 id="首先下载官网提供的dashboard-yaml"><a href="#首先下载官网提供的dashboard-yaml" class="headerlink" title="首先下载官网提供的dashboard.yaml"></a>首先下载官网提供的dashboard.yaml</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/kubernetes/dashboard/master/src/deploy/recommended/kubernetes-dashboard.yaml</span><br></pre></td></tr></table></figure>
<h3 id="修改yaml-添加NodePort"><a href="#修改yaml-添加NodePort" class="headerlink" title="修改yaml,添加NodePort."></a>修改yaml,添加NodePort.</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  # 添加Service的type为NodePort</span><br><span class="line">  type: NodePort</span><br><span class="line">  ports:</span><br><span class="line">    - port: 443</span><br><span class="line">      targetPort: 8443</span><br><span class="line">      # 添加映射到虚拟机的端口,k8s只支持30000以上的端口</span><br><span class="line">      nodePort: 30001</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br></pre></td></tr></table></figure>
<h3 id="安装dashboard-1"><a href="#安装dashboard-1" class="headerlink" title="安装dashboard"></a>安装dashboard</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f kubernetes-dashboard.yaml</span><br></pre></td></tr></table></figure>
<h3 id="获取token"><a href="#获取token" class="headerlink" title="获取token"></a>获取token</h3><p>这里有一个简单的命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system describe $(kubectl -n kube-system get secret -n kube-system -o name | grep namespace) | grep token</span><br></pre></td></tr></table></figure></p>
<p>也可以自己手动查询：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 输入下面命令查询kube-system命名空间下的所有secret</span><br><span class="line">kubectl get secret -n kube-system</span><br><span class="line"></span><br><span class="line"># 然后获取token。只要是type为service-account-token的secret的token都可以使用。</span><br><span class="line"># 比如我们获取replicaset-controller-token-wsv4v的touken</span><br><span class="line">kubectl -n kube-system describe replicaset-controller-token-wsv4v</span><br></pre></td></tr></table></figure></p>
<h3 id="访问dashboard"><a href="#访问dashboard" class="headerlink" title="访问dashboard"></a>访问dashboard</h3><p>通过node节点的ip，加刚刚我们设置的nodePort就可以访问了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://&lt;node-ip&gt;:&lt;node-port&gt;</span><br></pre></td></tr></table></figure></p>
<p>认证有两种方式：</p>
<ul>
<li>通过我们刚刚获取的token直接认证</li>
<li><p>通过Kubeconfig文件认证</p>
<p>只需要在kubeadm生成的admin.conf文件末尾加上刚刚获取的token就好了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- name: kubernetes-admin</span><br><span class="line">user:</span><br><span class="line">  client-certificate-data: xxxxxxxx</span><br><span class="line">  client-key-data: xxxxxx</span><br><span class="line">  token: &quot;在这里加上token&quot;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://segmentfault.com/a/1190000013681047" target="_blank" rel="noopener">kubernetes1.9安装dashboard，以及token认证问题</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhanghongtong.github.io/2018/10/23/在k8s上搭建emqx自动集群/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张奇怪">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张奇怪的blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/23/在k8s上搭建emqx自动集群/" itemprop="url">在k8s上搭建emqx自动集群</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-10-23T10:20:42+08:00">
                2018-10-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/kubernetes/" itemprop="url" rel="index">
                    <span itemprop="name">kubernetes</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Emqx 支持通过Kubernetes 服务自动集群。在<a href="https://zhanghongtong.github.io/2018/10/09/ubuntu-%E4%BD%BF%E7%94%A8kubeadm%E5%AE%89%E8%A3%85kubernetes/">ubuntu 使用kubeadm安装kubernetes</a>中使用kubeadm搭建了一个三台节点的k8s集群，接来下在这个集群中使用Emqx的自动集群功能搭建一个emqx集群。</p>
<p>本文需要对k8s集群的资源如pods、services等有基本的概念，可以阅读<a href="https://kubernetes.io/docs/concepts/workloads/" target="_blank" rel="noopener">官方文档</a>来了解。</p>
<h2 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h2><ul>
<li>公有云环境：AWS EC2</li>
<li>操作系统：ubuntu 16.04</li>
<li>kubeadm version：v1.12.1</li>
<li>Docker version：18.6.1</li>
<li>集群节点<br>  |   hostname    |    节点角色   |   IP地址        |<br>  |   —         |    —    |   —             |<br>  |   kube-node1     |    master     |   172.31.18.155   |<br>  |   kube-node2     |    worker     |   172.31.21.171   |<br>  |   kube-node3     |    worker     |   172.31.20.189   |</li>
</ul>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><h3 id="查看k8s集群状态"><a href="#查看k8s集群状态" class="headerlink" title="查看k8s集群状态"></a>查看k8s集群状态</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get node -o wide</span><br><span class="line">NAME         STATUS   ROLES    AGE   VERSION   INTERNAL-IP     EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION    CONTAINER-RUNTIME</span><br><span class="line">kube-node1   Ready    master   28h   v1.12.1   172.31.18.155   &lt;none&gt;        Ubuntu 18.04.1 LTS   4.15.0-1021-aws   docker://18.6.1</span><br><span class="line">kube-node2   Ready    &lt;none&gt;   28h   v1.12.1   172.31.21.171   &lt;none&gt;        Ubuntu 18.04.1 LTS   4.15.0-1021-aws   docker://18.6.1</span><br><span class="line">kube-node3   Ready    &lt;none&gt;   28h   v1.12.1   172.31.20.189   &lt;none&gt;        Ubuntu 18.04.1 LTS   4.15.0-1021-aws   docker://18.6.1</span><br><span class="line"></span><br><span class="line">$ kubectl get pods --all-namespaces -o wide</span><br><span class="line">NAMESPACE     NAME                                 READY   STATUS    RESTARTS   AGE     IP          NODE         NOMINATED NODE</span><br><span class="line">kube-system   coredns-576cbf47c7-b5xbb             1/1     Running   0          28h   10.244.0.5      kube-node1   &lt;none&gt;</span><br><span class="line">kube-system   coredns-576cbf47c7-g5s9j             1/1     Running   0          28h   10.244.0.4      kube-node1   &lt;none&gt;</span><br><span class="line">kube-system   etcd-kube-node1                      1/1     Running   0          28h   172.31.18.155   kube-node1   &lt;none&gt;</span><br><span class="line">kube-system   kube-apiserver-kube-node1            1/1     Running   0          28h   172.31.18.155   kube-node1   &lt;none&gt;</span><br><span class="line">kube-system   kube-controller-manager-kube-node1   1/1     Running   0          28h   172.31.18.155   kube-node1   &lt;none&gt;</span><br><span class="line">kube-system   kube-flannel-ds-amd64-fscrm          1/1     Running   0          28h   172.31.20.189   kube-node3   &lt;none&gt;</span><br><span class="line">kube-system   kube-flannel-ds-amd64-hhj8b          1/1     Running   0          28h   172.31.21.171   kube-node2   &lt;none&gt;</span><br><span class="line">kube-system   kube-flannel-ds-amd64-l6ccn          1/1     Running   0          28h   172.31.18.155   kube-node1   &lt;none&gt;</span><br><span class="line">kube-system   kube-proxy-79thv                     1/1     Running   0          28h   172.31.20.189   kube-node3   &lt;none&gt;</span><br><span class="line">kube-system   kube-proxy-ckg9t                     1/1     Running   0          28h   172.31.21.171   kube-node2   &lt;none&gt;</span><br><span class="line">kube-system   kube-proxy-skq8m                     1/1     Running   0          28h   172.31.18.155   kube-node1   &lt;none&gt;</span><br><span class="line">kube-system   kube-scheduler-kube-node1            1/1     Running   0          28h   172.31.18.155   kube-node1   &lt;none&gt;</span><br></pre></td></tr></table></figure>
<h3 id="查看apiserver配置"><a href="#查看apiserver配置" class="headerlink" title="查看apiserver配置"></a>查看apiserver配置</h3><p>Emqx自动集群功能需要用到k8s的apiserver，先看一下apiserver的具体配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl describe pods kube-apiserver-kube-node1 -n kube-system  </span><br><span class="line">Name:               kube-apiserver-kube-node1</span><br><span class="line">Namespace:          kube-system</span><br><span class="line">Priority:           2000000000</span><br><span class="line">PriorityClassName:  system-cluster-critical</span><br><span class="line">Node:               kube-node1/172.31.18.155</span><br><span class="line">Start Time:         Tue, 23 Oct 2018 02:29:37 +0000</span><br><span class="line">Labels:             component=kube-apiserver</span><br><span class="line">                    tier=control-plane</span><br><span class="line">Annotations:        kubernetes.io/config.hash: c5ac975e628056601100307026359ba8</span><br><span class="line">                    kubernetes.io/config.mirror: c5ac975e628056601100307026359ba8</span><br><span class="line">                    kubernetes.io/config.seen: 2018-10-17T02:00:07.757483468Z</span><br><span class="line">                    kubernetes.io/config.source: file</span><br><span class="line">                    scheduler.alpha.kubernetes.io/critical-pod: </span><br><span class="line">Status:             Running</span><br><span class="line">IP:                 172.31.18.155</span><br><span class="line">Containers:</span><br><span class="line">  kube-apiserver:</span><br><span class="line">    Container ID:  docker://d753a932b41ff8a99b6a11767d463f13af7e9de7526567df6eb5bd29a101f17b</span><br><span class="line">    Image:         k8s.gcr.io/kube-apiserver:v1.12.1</span><br><span class="line">    Image ID:      docker-pullable://k8s.gcr.io/kube-apiserver@sha256:52b9dae126b5a99675afb56416e9ae69239e012028668f7274e30ae16112bb1f</span><br><span class="line">    Port:          &lt;none&gt;</span><br><span class="line">    Host Port:     &lt;none&gt;</span><br><span class="line">    Command:</span><br><span class="line">      kube-apiserver</span><br><span class="line">      --authorization-mode=Node,RBAC</span><br><span class="line">      --advertise-address=172.31.18.155</span><br><span class="line">      --allow-privileged=true</span><br><span class="line">      --client-ca-file=/etc/kubernetes/pki/ca.crt</span><br><span class="line">      --enable-admission-plugins=NodeRestriction</span><br><span class="line">      --enable-bootstrap-token-auth=true</span><br><span class="line">      --etcd-cafile=/etc/kubernetes/pki/etcd/ca.crt</span><br><span class="line">      --etcd-certfile=/etc/kubernetes/pki/apiserver-etcd-client.crt</span><br><span class="line">      --etcd-keyfile=/etc/kubernetes/pki/apiserver-etcd-client.key</span><br><span class="line">      --etcd-servers=https://127.0.0.1:2379</span><br><span class="line">      --insecure-port=0</span><br><span class="line">      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver-kubelet-client.crt</span><br><span class="line">      --kubelet-client-key=/etc/kubernetes/pki/apiserver-kubelet-client.key</span><br><span class="line">      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname</span><br><span class="line">      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.crt</span><br><span class="line">      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client.key</span><br><span class="line">      --requestheader-allowed-names=front-proxy-client</span><br><span class="line">      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt</span><br><span class="line">      --requestheader-extra-headers-prefix=X-Remote-Extra-</span><br><span class="line">      --requestheader-group-headers=X-Remote-Group</span><br><span class="line">      --requestheader-username-headers=X-Remote-User</span><br><span class="line">      --secure-port=6443</span><br><span class="line">      --service-account-key-file=/etc/kubernetes/pki/sa.pub</span><br><span class="line">      --service-cluster-ip-range=10.96.0.0/12</span><br><span class="line">      --tls-cert-file=/etc/kubernetes/pki/apiserver.crt</span><br><span class="line">      --tls-private-key-file=/etc/kubernetes/pki/apiserver.key</span><br><span class="line">    State:          Running</span><br><span class="line">      Started:      Tue, 23 Oct 2018 02:29:39 +0000</span><br><span class="line">    Last State:     Terminated</span><br><span class="line">      Reason:       Completed</span><br><span class="line">      Exit Code:    0</span><br><span class="line">      Started:      Wed, 17 Oct 2018 02:00:09 +0000</span><br><span class="line">      Finished:     Thu, 18 Oct 2018 12:43:31 +0000</span><br><span class="line">    Ready:          True</span><br><span class="line">    Restart Count:  1</span><br><span class="line">    Requests:</span><br><span class="line">      cpu:        250m</span><br><span class="line">    Liveness:     http-get https://172.31.18.155:6443/healthz delay=15s timeout=15s period=10s #success=1 #failure=8</span><br><span class="line">    Environment:  &lt;none&gt;</span><br><span class="line">    Mounts:</span><br><span class="line">      /etc/ca-certificates from etc-ca-certificates (ro)</span><br><span class="line">      /etc/kubernetes/pki from k8s-certs (ro)</span><br><span class="line">      /etc/ssl/certs from ca-certs (ro)</span><br><span class="line">      /usr/local/share/ca-certificates from usr-local-share-ca-certificates (ro)</span><br><span class="line">      /usr/share/ca-certificates from usr-share-ca-certificates (ro)</span><br><span class="line">Conditions:</span><br><span class="line">  Type              Status</span><br><span class="line">  Initialized       True </span><br><span class="line">  Ready             True </span><br><span class="line">  ContainersReady   True </span><br><span class="line">  PodScheduled      True </span><br><span class="line">Volumes:</span><br><span class="line">  k8s-certs:</span><br><span class="line">    Type:          HostPath (bare host directory volume)</span><br><span class="line">    Path:          /etc/kubernetes/pki</span><br><span class="line">    HostPathType:  DirectoryOrCreate</span><br><span class="line">  ca-certs:</span><br><span class="line">    Type:          HostPath (bare host directory volume)</span><br><span class="line">    Path:          /etc/ssl/certs</span><br><span class="line">    HostPathType:  DirectoryOrCreate</span><br><span class="line">  usr-share-ca-certificates:</span><br><span class="line">    Type:          HostPath (bare host directory volume)</span><br><span class="line">    Path:          /usr/share/ca-certificates</span><br><span class="line">    HostPathType:  DirectoryOrCreate</span><br><span class="line">  usr-local-share-ca-certificates:</span><br><span class="line">    Type:          HostPath (bare host directory volume)</span><br><span class="line">    Path:          /usr/local/share/ca-certificates</span><br><span class="line">    HostPathType:  DirectoryOrCreate</span><br><span class="line">  etc-ca-certificates:</span><br><span class="line">    Type:          HostPath (bare host directory volume)</span><br><span class="line">    Path:          /etc/ca-certificates</span><br><span class="line">    HostPathType:  DirectoryOrCreate</span><br><span class="line">QoS Class:         Burstable</span><br><span class="line">Node-Selectors:    &lt;none&gt;</span><br><span class="line">Tolerations:       :NoExecute</span><br><span class="line">Events:            &lt;none&gt;</span><br></pre></td></tr></table></figure></p>
<p>通过 <code>--advertise-address=172.31.18.155</code> 获得apiserver的IP地址（该地址在使用<code>kubeadm init</code> 命令创建集群的时候可以通过 <code>--apiserver-advertise-address=172.31.18.155</code> 参数来指定)，通过<code>--authorization-mode=Node,RBAC</code> 可以看到apiserver的访问规则为只有节点或者配置了合理的RBAC规则的pod可以访问。</p>
<h3 id="在节点上访问apiserver"><a href="#在节点上访问apiserver" class="headerlink" title="在节点上访问apiserver"></a>在节点上访问apiserver</h3><p>执行 <code>curl http://172.31.18.155:8080</code> 访问apiserver发现报错 <code>Connection refused</code>，使用 <code>netstat -apn | grep 8080</code>命令查看发现并没有进程监听8080端口。</p>
<p>执行<code>kubectl proxy --help</code>命令可以看到<code>kubectl proxy</code>可以在本机和apiserver之间创建一个代理服务器，它允许指定规则的http访问。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl proxy --accept-hosts=&quot;^.*$&quot; --address=&apos;172.31.18.155&apos; -p=8080 &amp;</span><br><span class="line">$ curl http://172.31.18.155:8080</span><br><span class="line">&#123;</span><br><span class="line">  &quot;paths&quot;: [</span><br><span class="line">    &quot;/api&quot;,</span><br><span class="line">    &quot;/api/v1&quot;,</span><br><span class="line">    &quot;/apis&quot;,</span><br><span class="line">    &quot;/apis/&quot;,</span><br><span class="line">    &quot;/apis/admissionregistration.k8s.io&quot;,</span><br><span class="line">    &quot;/apis/admissionregistration.k8s.io/v1beta1&quot;,</span><br><span class="line">    &quot;/apis/apiextensions.k8s.io&quot;,</span><br><span class="line">    &quot;/apis/apiextensions.k8s.io/v1beta1&quot;,</span><br><span class="line">    &quot;/apis/apiregistration.k8s.io&quot;,</span><br><span class="line">    &quot;/apis/apiregistration.k8s.io/v1&quot;,</span><br><span class="line">    &quot;/apis/apiregistration.k8s.io/v1beta1&quot;,</span><br><span class="line">    ......</span><br></pre></td></tr></table></figure></p>
<h2 id="创建服务"><a href="#创建服务" class="headerlink" title="创建服务"></a>创建服务</h2><p>kubectl可以通过 kubectl create -f xxx.yml来创建各种资源，那么只需要编写一个或多个合法的yml文件就可以创建emqx集群了。本文将所有资源都写在了一个yml文件中，在实际生产中，可以在一个目录下创建多个yml文件，并使用<code>kubectl create -f 目录名</code>来部署。<br>为了方便理解和学习，在本次实验中，将需要创建的资源类型和命名提前确定下来<br>|   资源类型         |   命名             |<br>|   ——–        |   —-            |<br>|   role            |   pod-reader      |<br>|   rolebinding     |   read-pods       |<br>|   serviceaccount  |   emqx-sa         |<br>|   service         |   emqx            |<br>|   deployment      |   emqx            |<br>|   pod             |   emqx            |</p>
<p>需要注意的是，一般来说service、deployment和pod最好命名为不同的名字以便区分，不过Emqx的自动集群功能需要将它们命名为统一的名字。</p>
<h3 id="Role"><a href="#Role" class="headerlink" title="Role"></a>Role</h3><p>上文我们查看了apiserver的配置，可以看到普通pod是没有权限访问apiserver的，必须要配置合法的RBAC规则策略才可以。</p>
<p>在RBAC API中，一个角色包含了一套表示一组权限的规则。 权限以纯粹的累加形式累积（没有”否定”的规则）。 角色可以由命名空间（namespace）内的Role对象定义，而整个Kubernetes集群范围内有效的角色则通过ClusterRole对象实现。</p>
<p>一个Role对象只能用于授予对某一单一命名空间中资源的访问权限。 以下示例描述了”default”命名空间中的一个Role对象的定义，用于授予对pod的读访问权限：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kind: Role</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  namespace: default</span><br><span class="line">  name: pod-reader</span><br><span class="line">rules:</span><br><span class="line">- apiGroups: [&quot;&quot;] </span><br><span class="line">  resources: [&quot;&quot;]</span><br><span class="line">  verbs: [&quot;get&quot;, &quot;watch&quot;, &quot;list&quot;]</span><br></pre></td></tr></table></figure></p>
<h3 id="RoleBinding"><a href="#RoleBinding" class="headerlink" title="RoleBinding"></a>RoleBinding</h3><p>角色绑定将一个角色中定义的各种权限授予一个或者一组用户。 角色绑定包含了一组相关主体（即subject, 包括用户——User、用户组——Group、或者服务账户——Service Account）以及对被授予角色的引用。 在命名空间中可以通过RoleBinding对象授予权限，而集群范围的权限授予则通过ClusterRoleBinding对象完成。</p>
<p>RoleBinding可以引用在同一命名空间内定义的Role对象。 下面示例中定义的RoleBinding对象在”default”命名空间中将”pod-reader”角色授予”emqx-sa”。 这一授权将允许”emqx-sa”从”default”命名空间中读取pod。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">kind: RoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: read-pods</span><br><span class="line">  namespace: default</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: emqx-sa</span><br><span class="line">  apiGroup: &quot;&quot;</span><br><span class="line">roleRef:</span><br><span class="line">  kind: Role</span><br><span class="line">  name: pod-reader</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br></pre></td></tr></table></figure>
<h3 id="Service-Account"><a href="#Service-Account" class="headerlink" title="Service Account"></a>Service Account</h3><p>创建好了RBAC规则之后，还需要创建Service Account，Service Account概念的引入是基于这样的使用场景：运行在pod里的进程需要调用Kubernetes API以及非Kubernetes API的其它服务。Service Account它并不是给kubernetes集群的用户使用的，而是给pod里面的进程使用的，它为pod提供必要的身份认证。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get sa --all-namespaces</span><br><span class="line">NAMESPACE     NAME                                 SECRETS   AGE</span><br><span class="line">default       default                              1         6d3h</span><br><span class="line">kube-public   default                              1         6d3h</span><br><span class="line">kube-system   attachdetach-controller              1         6d3h</span><br><span class="line">kube-system   bootstrap-signer                     1         6d3h</span><br><span class="line">kube-system   certificate-controller               1         6d3h</span><br><span class="line">kube-system   clusterrole-aggregation-controller   1         6d3h</span><br><span class="line">kube-system   coredns                              1         6d3h</span><br><span class="line">kube-system   cronjob-controller                   1         6d3h</span><br><span class="line">kube-system   daemon-set-controller                1         6d3h</span><br><span class="line">kube-system   default                              1         6d3h</span><br><span class="line">kube-system   deployment-controller                1         6d3h</span><br><span class="line">kube-system   disruption-controller                1         6d3h</span><br><span class="line">kube-system   endpoint-controller                  1         6d3h</span><br><span class="line">kube-system   expand-controller                    1         6d3h</span><br><span class="line">kube-system   flannel                              1         6d3h</span><br><span class="line">kube-system   generic-garbage-collector            1         6d3h</span><br><span class="line">kube-system   horizontal-pod-autoscaler            1         6d3h</span><br><span class="line">kube-system   job-controller                       1         6d3h</span><br><span class="line">kube-system   kube-proxy                           1         6d3h</span><br><span class="line">kube-system   namespace-controller                 1         6d3h</span><br><span class="line">kube-system   node-controller                      1         6d3h</span><br><span class="line">kube-system   persistent-volume-binder             1         6d3h</span><br><span class="line">kube-system   pod-garbage-collector                1         6d3h</span><br><span class="line">kube-system   pv-protection-controller             1         6d3h</span><br><span class="line">kube-system   pvc-protection-controller            1         6d3h</span><br><span class="line">kube-system   replicaset-controller                1         6d3h</span><br><span class="line">kube-system   replication-controller               1         6d3h</span><br><span class="line">kube-system   resourcequota-controller             1         6d3h</span><br><span class="line">kube-system   service-account-controller           1         6d3h</span><br><span class="line">kube-system   service-controller                   1         6d3h</span><br><span class="line">kube-system   statefulset-controller               1         6d3h</span><br><span class="line">kube-system   token-cleaner                        1         6d3h</span><br><span class="line">kube-system   ttl-controller                       1         6d3h</span><br></pre></td></tr></table></figure></p>
<p>如果kubernetes开启了ServiceAccount（–admission_control=…,ServiceAccount,… ）那么会在每个namespace下面都会创建一个默认的default的sa。<br>如下，其中最重要的就是secrets，它是每个sa下面都会拥有的一个加密的token，当用户再该namespace下创建pod的时候都会默认使用这个sa。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get sa  default  -o yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: 2018-10-17T02:00:36Z</span><br><span class="line">  name: default</span><br><span class="line">  namespace: default</span><br><span class="line">  resourceVersion: &quot;342&quot;</span><br><span class="line">  selfLink: /api/v1/namespaces/default/serviceaccounts/default</span><br><span class="line">  uid: 70ae05df-d1b0-11e8-bc24-0a7114fbf79e</span><br><span class="line">secrets:</span><br><span class="line">- name: default-token-7gd5l</span><br></pre></td></tr></table></figure></p>
<p>创建ServiceSAccount<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceSAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: emqx-sa</span><br><span class="line">  namespace: default</span><br></pre></td></tr></table></figure></p>
<h3 id="Deployment-amp-amp-Pod"><a href="#Deployment-amp-amp-Pod" class="headerlink" title="Deployment &amp;&amp; Pod"></a>Deployment &amp;&amp; Pod</h3><p>查看<a href="http://emqtt.com/docs/v3/config.html#id7" target="_blank" rel="noopener">Emqx官方文档</a>中基于 Kubernetes 自动集群的相关配置，需要将<code>etc/emqx.conf</code>的配置做如下修改。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cluster.discovery = k8s</span><br><span class="line"></span><br><span class="line">##--------------------------------------------------------------------</span><br><span class="line">## Cluster with k8s</span><br><span class="line"></span><br><span class="line">cluster.k8s.apiserver = http://10.110.111.204:8080</span><br><span class="line"></span><br><span class="line">cluster.k8s.service_name = emqx</span><br><span class="line"></span><br><span class="line">## Address Type: ip | dns</span><br><span class="line">cluster.k8s.address_type = ip</span><br><span class="line"></span><br><span class="line">## The Erlang application name</span><br><span class="line">cluster.k8s.app_name = emqx</span><br><span class="line"></span><br><span class="line">## Kubernates Namespace</span><br><span class="line">cluster.k8s.namespace = default</span><br></pre></td></tr></table></figure></p>
<p>查看<a href="https://github.com/emqx/emqx-docker/blob/master/README.md" target="_blank" rel="noopener">Github上关于Emqx镜像的文档</a>，可以使用编辑环境变量的方式来修改<code>etc/emqx.conf</code>，根据上文所需的配置，我们可以指定如下环境变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">- name: EMQX_CLUSTER__DISCOVERY</span><br><span class="line">    value: k8s</span><br><span class="line">- name: EMQX_NAME</span><br><span class="line">    value: emqx</span><br><span class="line">- name: EMQX_CLUSTER__K8S__APISERVER</span><br><span class="line">    value: http://172.31.19.161:8080</span><br><span class="line">- name: EMQX_CLUSTER__K8S__NAMESPACE</span><br><span class="line">    value: default</span><br><span class="line">- name: EMQX_CLUSTER__K8S__SERVICE_NAME</span><br><span class="line">    value: emqx</span><br><span class="line">- name: EMQX_CLUSTER__K8S__ADDRESS_TYPE</span><br><span class="line">    value: ip</span><br><span class="line">- name: EMQX_CLUSTER__K8S__APP_NAME</span><br><span class="line">    value: emqx</span><br></pre></td></tr></table></figure>
<p>创建deployment和pod，因为k8s不能直接使用Dockerfile去编译镜像，只能从docker的镜像仓库中拉取，所以pod使用<a href="https://hub.docker.com/r/emqx/emqx/" target="_blank" rel="noopener">docker hub</a>的镜像。指定部署两个emqx镜像的pod，并指定pod的端口和环境变量。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: emqx</span><br><span class="line">  labels:</span><br><span class="line">        app: emqx</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: emqx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: emqx</span><br><span class="line">        image: emqx/emqx:latest</span><br><span class="line">        ports:</span><br><span class="line">        - name: emqx-dashboard</span><br><span class="line">          containerPort: 18083</span><br><span class="line">        - name: emqx-http</span><br><span class="line">          containerPort: 8083</span><br><span class="line">        - name: emqx-mqtt</span><br><span class="line">          containerPort: 1883</span><br><span class="line">        env:</span><br><span class="line">        - name: EMQX_CLUSTER__DISCOVERY</span><br><span class="line">          value: k8s</span><br><span class="line">        - name: EMQX_NAME</span><br><span class="line">          value: emqx</span><br><span class="line">        - name: EMQX_CLUSTER__K8S__APISERVER</span><br><span class="line">          value: http://172.31.19.161:8080</span><br><span class="line">        - name: EMQX_CLUSTER__K8S__NAMESPACE</span><br><span class="line">          value: default</span><br><span class="line">        - name: EMQX_CLUSTER__K8S__SERVICE_NAME</span><br><span class="line">          value: emqx</span><br><span class="line">        - name: EMQX_CLUSTER__K8S__ADDRESS_TYPE</span><br><span class="line">          value: ip</span><br><span class="line">        - name: EMQX_CLUSTER__K8S__APP_NAME</span><br><span class="line">          value: emqx</span><br><span class="line">        tty: true</span><br></pre></td></tr></table></figure></p>
<h3 id="Servives"><a href="#Servives" class="headerlink" title="Servives"></a>Servives</h3><p>创建Service，方便访问Emqx的dashboard。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: emqx</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 32333</span><br><span class="line">    nodePort: 32333</span><br><span class="line">    targetPort:  emqx-dashboard</span><br><span class="line">    protocol: TCP</span><br><span class="line">  selector:</span><br><span class="line">    app: emqx</span><br><span class="line">  type: NodePort</span><br></pre></td></tr></table></figure></p>
<h2 id="部署服务"><a href="#部署服务" class="headerlink" title="部署服务"></a>部署服务</h2><p>查看一下emqx.yml文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">cat emqx.yml</span><br><span class="line"></span><br><span class="line">kind: Role</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  namespace: default</span><br><span class="line">  name: pod-reader</span><br><span class="line">rules:</span><br><span class="line">- apiGroups: [&quot;&quot;] </span><br><span class="line">  resources: [&quot;&quot;]</span><br><span class="line">  verbs: [&quot;get&quot;, &quot;watch&quot;, &quot;list&quot;]</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">kind: RoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: read-pods</span><br><span class="line">  namespace: default</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: emqx-sa</span><br><span class="line">  apiGroup: &quot;&quot;</span><br><span class="line">roleRef:</span><br><span class="line">  kind: Role</span><br><span class="line">  name: pod-reader</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: emqx-sa</span><br><span class="line">  namespace: default</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: emqx</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 32333</span><br><span class="line">    nodePort: 32333</span><br><span class="line">    targetPort:  emqx-dashboard</span><br><span class="line">    protocol: TCP</span><br><span class="line">  selector:</span><br><span class="line">    app: emqx</span><br><span class="line">  type: NodePort</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: emqx</span><br><span class="line">  labels:</span><br><span class="line">        app: emqx</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: emqx</span><br><span class="line">    spec:</span><br><span class="line">      nodeName: ip-172-31-23-51</span><br><span class="line">      containers:</span><br><span class="line">      - name: emqx</span><br><span class="line">        image: emqx/emqx:latest</span><br><span class="line">        ports:</span><br><span class="line">        - name: emqx-dashboard</span><br><span class="line">          containerPort: 18083</span><br><span class="line">        - name: emqx-http</span><br><span class="line">          containerPort: 8083</span><br><span class="line">        - name: emqx-mqtt</span><br><span class="line">          containerPort: 1883</span><br><span class="line">        env:</span><br><span class="line">        - name: EMQX_CLUSTER__DISCOVERY</span><br><span class="line">          value: k8s</span><br><span class="line">        - name: EMQX_NAME</span><br><span class="line">          value: emqx</span><br><span class="line">        - name: EMQX_CLUSTER__K8S__APISERVER</span><br><span class="line">          value: http://172.31.19.161:8080</span><br><span class="line">        - name: EMQX_CLUSTER__K8S__NAMESPACE</span><br><span class="line">          value: default</span><br><span class="line">        - name: EMQX_CLUSTER__K8S__SERVICE_NAME</span><br><span class="line">          value: emqx</span><br><span class="line">        - name: EMQX_CLUSTER__K8S__ADDRESS_TYPE</span><br><span class="line">          value: ip</span><br><span class="line">        - name: EMQX_CLUSTER__K8S__APP_NAME</span><br><span class="line">          value: emqx</span><br><span class="line">        tty: true</span><br></pre></td></tr></table></figure></p>
<p>部署emqx<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f emqx.yml </span><br><span class="line">role.rbac.authorization.k8s.io/pod-reader created</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/read-pods created</span><br><span class="line">serviceaccount/emqx-sa created</span><br><span class="line">service/emqx created</span><br><span class="line">deployment.extensions/emqx created</span><br></pre></td></tr></table></figure></p>
<p>查看部署的状态，可以看到所有的资源都成功部署了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get all -o wide</span><br><span class="line">NAME                                  READY   STATUS        RESTARTS   AGE     IP            NODE         NOMINATED NODE</span><br><span class="line">pod/emqx-7685fc45cd-qmxlq             1/1     Running       0          3m22s   10.244.2.14   kube-node3   &lt;none&gt;</span><br><span class="line">pod/emqx-7685fc45cd-zq2cj             1/1     Running       0          3m22s   10.244.1.18   kube-node2   &lt;none&gt;</span><br><span class="line"></span><br><span class="line">NAME                 TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)           AGE     SELECTOR</span><br><span class="line">service/emqx         NodePort    10.109.165.143   &lt;none&gt;        32333:32333/TCP   3m22s   app=emqx</span><br><span class="line">service/kubernetes   ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP           6d4h    &lt;none&gt;</span><br><span class="line"></span><br><span class="line">NAME                   DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE     CONTAINERS   IMAGES             SELECTOR</span><br><span class="line">deployment.apps/emqx   2         2         2            2           3m22s   emqx         emqx/emqx:latest   app=emqx</span><br><span class="line"></span><br><span class="line">NAME                              DESIRED   CURRENT   READY   AGE     CONTAINERS   IMAGES             SELECTOR</span><br><span class="line">replicaset.apps/emqx-7685fc45cd   2         2         2       3m22s   emqx         emqx/emqx:latest   app=emqx,pod-template-hash=7685fc45cd</span><br></pre></td></tr></table></figure></p>
<p>使用命令行查看集群状态，可以看到emqx已自动集群。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl exec -it emqx-7685fc45cd-qmxlq /opt/emqx/bin/emqx_ctl cluster status</span><br><span class="line">Cluster status: [&#123;running_nodes,[&apos;emqx@10.244.1.18&apos;,&apos;emqx@10.244.2.14&apos;]&#125;]</span><br></pre></td></tr></table></figure></p>
<p>即使删掉一个pod，k8s也会自动创建出一个新的pod来自动集群<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete pod/emqx-7685fc45cd-zq2cj</span><br><span class="line">pod &quot;emqx-7685fc45cd-zq2cj&quot; deleted</span><br><span class="line"></span><br><span class="line">$ kubectl get pods </span><br><span class="line">NAME                    READY   STATUS    RESTARTS   AGE</span><br><span class="line">emqx-7685fc45cd-nt54v   1/1     Running   0          56s</span><br><span class="line">emqx-7685fc45cd-qmxlq   1/1     Running   0          6m25</span><br><span class="line"></span><br><span class="line">$ kubectl exec -it emqx-7685fc45cd-qmxlq /opt/emqx/bin/emqx_ctl cluster status</span><br><span class="line">Cluster status: [&#123;running_nodes,[&apos;emqx@10.244.1.19&apos;,&apos;emqx@10.244.2.14&apos;]&#125;,</span><br><span class="line">                 &#123;stopped_nodes,[&apos;emqx@10.244.1.18&apos;]&#125;]</span><br></pre></td></tr></table></figure></p>
<p>打开浏览器，输入<code>http://任意节点的公网IP：32333</code>可以成功访问Emqx的dashboard页面。</p>
<p>参考资料</p>
<ul>
<li><a href="https://blog.csdn.net/u010278923/article/details/72857928" target="_blank" rel="noopener">kubernetes的Service Account和secret</a></li>
<li><a href="https://jimmysong.io/kubernetes-handbook/guide/rbac.html" target="_blank" rel="noopener">RBAC——基于角色的访问控制</a></li>
<li><a href="http://blog.51cto.com/ylw6006/2113542" target="_blank" rel="noopener">K8S使用dashboard管理集群</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="张奇怪" />
          <p class="site-author-name" itemprop="name">张奇怪</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">41</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">20</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">张奇怪</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  





  

  

  

  

  

  

</body>
</html>
